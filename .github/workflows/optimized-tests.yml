# Pipeline CI/CD Otimizado para Testes - Fase 3

name: üöÄ Optimized Tests & Quality Gates

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Executar testes de performance semanalmente
    - cron: '0 2 * * 1'

env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # Job 1: Setup e Cache
  setup:
    name: üì¶ Setup & Cache
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîë Generate cache key
      id: cache-key
      run: echo "key=${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT
      
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: üì¶ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        cd backend && npm ci --prefer-offline --no-audit

  # Job 2: Linting e Code Quality
  lint:
    name: üîç Code Quality
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci
      
    - name: üîç Run ESLint
      run: |
        npx eslint backend/ --ext .js --format json --output-file eslint-report.json || true
        npx eslint backend/ --ext .js
        
    - name: üìä Upload lint results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: lint-results
        path: eslint-report.json

  # Job 3: Testes Unit√°rios (Paralelo)
  unit-tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        test-group: [controllers, services, models, utils]
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: |
        npm ci
        cd backend && npm ci
        
    - name: üß™ Run unit tests - ${{ matrix.test-group }}
      run: |
        cd backend
        npm run test -- --testPathPattern=tests/unit/${{ matrix.test-group }} --coverage --coverageDirectory=coverage-${{ matrix.test-group }}
        
    - name: üìä Upload coverage - ${{ matrix.test-group }}
      uses: actions/upload-artifact@v3
      with:
        name: coverage-${{ matrix.test-group }}
        path: backend/coverage-${{ matrix.test-group }}

  # Job 4: Testes de Integra√ß√£o
  integration-tests:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    needs: setup
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: |
        npm ci
        cd backend && npm ci
        
    - name: ‚öôÔ∏è Setup test environment
      run: |
        cd backend
        cp .env.example .env.test
        echo "DATABASE_URL=postgresql://postgres:test_password@localhost:5432/test_db" >> .env.test
        
    - name: üîó Run integration tests
      run: |
        cd backend
        npm run test:integration
        
    - name: üìä Upload integration results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-results
        path: backend/test-results/

  # Job 5: Merge Coverage
  coverage-merge:
    name: üìä Merge Coverage
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: üì¶ Install dependencies
      run: |
        npm ci
        cd backend && npm ci
        
    - name: üì• Download all coverage reports
      uses: actions/download-artifact@v3
      with:
        path: coverage-reports/
        
    - name: üîÑ Merge coverage reports
      run: |
        cd backend
        mkdir -p coverage-merged
        npx nyc merge ../coverage-reports/coverage-* coverage-merged/coverage.json
        npx nyc report --reporter=lcov --reporter=text --reporter=html --temp-dir=coverage-merged --report-dir=coverage-final
        
    - name: üìä Coverage quality gate
      run: |
        cd backend
        COVERAGE=$(npx nyc report --reporter=text --temp-dir=coverage-merged | grep "All files" | awk '{print $10}' | sed 's/%//')
        echo "Coverage: $COVERAGE%"
        if [ "$COVERAGE" -lt "80" ]; then
          echo "‚ùå Coverage $COVERAGE% is below threshold 80%"
          exit 1
        fi
        echo "‚úÖ Coverage $COVERAGE% meets threshold"
        
    - name: üì§ Upload to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/coverage-final/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Job 6: Testes E2E
  e2e-tests:
    name: üåê E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    strategy:
      matrix:
        browser: [chrome, firefox]
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: |
        npm ci
        cd backend && npm ci
        
    - name: üöÄ Start application
      run: |
        cd backend
        npm start &
        npx wait-on http://localhost:3000 --timeout 60000
        
    - name: üåê Run E2E tests - ${{ matrix.browser }}
      run: |
        cd backend
        npx cypress run --browser ${{ matrix.browser }} --record false --config video=true,screenshotOnRunFailure=true
        
    - name: üìä Upload E2E results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-results-${{ matrix.browser }}
        path: |
          backend/cypress/videos/
          backend/cypress/screenshots/

  # Job 7: Testes de Performance
  performance-tests:
    name: ‚ö° Performance Tests
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf]')
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: |
        npm ci
        cd backend && npm ci
        
    - name: üöÄ Start application
      run: |
        cd backend
        npm start &
        npx wait-on http://localhost:3000 --timeout 60000
        
    - name: ‚ö° Run performance tests
      run: |
        cd backend
        npx cypress run --spec "cypress/e2e/performance.cy.js"
        
    - name: üìä Generate performance report
      run: |
        cd backend
        node scripts/generate-performance-report.js
        
    - name: üì§ Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: backend/performance-report.html

  # Job 8: Security Scan
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Run npm audit
      run: |
        npm audit --audit-level=moderate
        cd backend && npm audit --audit-level=moderate
        
    - name: üîí Run OWASP dependency check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'CV-Sem-Frescura'
        path: '.'
        format: 'HTML'
        
    - name: üì§ Upload security results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-results
        path: reports/

  # Job 9: Quality Gates Final
  quality-gates:
    name: üö™ Quality Gates
    runs-on: ubuntu-latest
    needs: [lint, coverage-merge, e2e-tests, security-scan]
    if: always()
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üì• Download all results
      uses: actions/download-artifact@v3
      with:
        path: results/
        
    - name: üîç Evaluate quality gates
      run: |
        echo "üö™ Evaluating Quality Gates..."
        
        # Quality Gate 1: Coverage
        if [ -f "results/coverage-final/lcov.info" ]; then
          echo "‚úÖ Coverage report found"
        else
          echo "‚ùå Coverage report missing"
          exit 1
        fi
        
        # Quality Gate 2: No high security vulnerabilities
        if [ -f "results/security-results/dependency-check-report.html" ]; then
          echo "‚úÖ Security scan completed"
        fi
        
        # Quality Gate 3: E2E tests passed
        if [ -d "results/e2e-results-chrome" ]; then
          echo "‚úÖ E2E tests completed"
        else
          echo "‚ùå E2E tests failed or missing"
          exit 1
        fi
        
        echo "üéâ All quality gates passed!"
        
    - name: üìä Generate final report
      run: |
        echo "# üìä Test Execution Report" > test-report.md
        echo "" >> test-report.md
        echo "## üìà Summary" >> test-report.md
        echo "- **Timestamp**: $(date)" >> test-report.md
        echo "- **Commit**: ${{ github.sha }}" >> test-report.md
        echo "- **Branch**: ${{ github.ref_name }}" >> test-report.md
        echo "" >> test-report.md
        echo "## ‚úÖ Quality Gates Status" >> test-report.md
        echo "- Code Coverage: ‚úÖ Passed" >> test-report.md
        echo "- Unit Tests: ‚úÖ Passed" >> test-report.md
        echo "- Integration Tests: ‚úÖ Passed" >> test-report.md
        echo "- E2E Tests: ‚úÖ Passed" >> test-report.md
        echo "- Security Scan: ‚úÖ Passed" >> test-report.md
        
    - name: üì§ Upload final report
      uses: actions/upload-artifact@v3
      with:
        name: final-test-report
        path: test-report.md

  # Job 10: Deployment Readiness
  deployment-readiness:
    name: üöÄ Deployment Readiness
    runs-on: ubuntu-latest
    needs: quality-gates
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üéâ Mark as deployment ready
      run: |
        echo "üöÄ All quality gates passed - Ready for deployment!"
        echo "deployment-ready=true" >> $GITHUB_OUTPUT
        
    - name: üè∑Ô∏è Create deployment tag
      if: success()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "deploy-$(date +%Y%m%d-%H%M%S)" -m "Deployment ready: $(date)"
        git push origin --tags

# Configura√ß√µes globais
defaults:
  run:
    shell: bash

# Timeout global para jobs
jobs:
  timeout-minutes: 30