<!DOCTYPE html>
<html>

<head>
    <title>üîß Teste Stripe V4 - Configura√ß√£o Din√¢mica</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: Inter, sans-serif;
            margin: 40px;
            background: #f9f9f9;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .success {
            background-color: #f0f8f0;
            border-color: #4CAF50;
        }

        .error {
            background-color: #fff0f0;
            border-color: #f44336;
        }

        .warning {
            background-color: #fff8e1;
            border-color: #ff9800;
        }

        button {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .primary {
            background-color: #583819;
            color: white;
        }

        .secondary {
            background-color: #6c757d;
            color: white;
        }

        .primary:hover {
            background-color: #6b4423;
        }

        .secondary:hover {
            background-color: #5a6268;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .highlight {
            background: #fffacd;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>üîß Teste Stripe V4 - Configura√ß√£o Din√¢mica (.env)</h1>

    <div class="alert alert-success">
        <strong>üöÄ NOVA VERS√ÉO:</strong> Agora busca as chaves diretamente do arquivo <code>.env</code> do backend!
    </div>

    <div class="test-section">
        <h2>0. üîÑ Carregar Configura√ß√µes do Backend</h2>
        <button class="secondary" onclick="carregarConfiguracoes()">Carregar do .env</button>
        <div id="config-result"></div>
    </div>

    <div class="test-section">
        <h2>1. üîó Teste de Conectividade</h2>
        <button class="primary" onclick="testarConectividade()">Testar Backend</button>
        <div id="conectividade-result"></div>
    </div>

    <div class="test-section">
        <h2>2. üí≥ Teste de PaymentIntent</h2>
        <button class="primary" onclick="testarPaymentIntent()">Criar PaymentIntent</button>
        <div id="payment-intent-result"></div>
    </div>

    <div class="test-section">
        <h2>3. üéØ Teste de Stripe Elements (CR√çTICO)</h2>
        <button class="primary" onclick="testarStripeElements()">Testar Elements</button>
        <div id="elements-result"></div>
        <div id="stripe-elements-container"
            style="margin-top: 20px; padding: 20px; border: 1px dashed #ccc; min-height: 100px;"></div>
    </div>

    <script>
        // ‚úÖ Configura√ß√µes globais
        const API_BASE = 'http://localhost:3000';
        let STRIPE_PUBLIC_KEY = null; // Ser√° carregada dinamicamente do .env
        let stripe = null;
        let currentClientSecret = null;

        // Fun√ß√£o auxiliar para mostrar resultados
        function mostrarResultado(elementId, conteudo, tipo = 'success') {
            const element = document.getElementById(elementId);
            element.className = `test-section ${tipo}`;
            element.innerHTML = conteudo;
        }

        // 0. Carregar configura√ß√µes do backend (.env)
        async function carregarConfiguracoes() {
            try {
                mostrarResultado('config-result', '‚è≥ Carregando configura√ß√µes do backend...', 'warning');

                const response = await fetch(`${API_BASE}/api/config/stripe-key`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                STRIPE_PUBLIC_KEY = data.publishableKey;

                const diagnostico = {
                    loaded: true,
                    key: STRIPE_PUBLIC_KEY,
                    environment: data.environment,
                    source: data.source,
                    timestamp: data.timestamp,
                    keyValid: STRIPE_PUBLIC_KEY && STRIPE_PUBLIC_KEY.startsWith('pk_'),
                    keyType: STRIPE_PUBLIC_KEY?.startsWith('pk_test_') ? 'test' : 'live'
                };

                const resultado = `
                    <h3>‚úÖ Configura√ß√µes Carregadas do Backend</h3>
                    <ul>
                        <li><strong>Fonte:</strong> <span class="status-badge status-success">${data.source}</span></li>
                        <li><strong>Ambiente:</strong> <span class="status-badge ${diagnostico.keyType === 'test' ? 'status-success' : 'status-error'}">${diagnostico.environment} (${diagnostico.keyType})</span></li>
                        <li><strong>Chave V√°lida:</strong> <span class="status-badge ${diagnostico.keyValid ? 'status-success' : 'status-error'}">${diagnostico.keyValid ? '‚úÖ Sim' : '‚ùå N√£o'}</span></li>
                        <li><strong>Carregada em:</strong> ${new Date(data.timestamp).toLocaleString('pt-BR')}</li>
                    </ul>
                    
                    <div class="highlight">
                        <strong>üîë Chave do .env:</strong><br>
                        <code style="font-size: 11px; word-break: break-all;">${STRIPE_PUBLIC_KEY}</code>
                    </div>

                    <div class="alert alert-success">
                        <strong>üéØ SUCESSO!</strong> Configura√ß√µes carregadas do arquivo .env do backend.<br>
                        <strong>Pr√≥ximo passo:</strong> Execute os testes 1, 2 e 3 na ordem.
                    </div>
                `;

                mostrarResultado('config-result', resultado, 'success');

                // Inicializar Stripe com a chave do backend
                if (diagnostico.keyValid && typeof Stripe !== 'undefined') {
                    try {
                        stripe = Stripe(STRIPE_PUBLIC_KEY);
                        console.log('‚úÖ Stripe inicializado com chave do backend (.env)');
                    } catch (error) {
                        console.error('‚ùå Erro ao inicializar Stripe:', error);
                    }
                }

            } catch (error) {
                mostrarResultado('config-result', `
                    <h3>‚ùå Erro ao Carregar Configura√ß√µes</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                    
                    <div class="alert alert-error">
                        <strong>Poss√≠veis causas:</strong>
                        <ul>
                            <li>Backend n√£o est√° rodando</li>
                            <li>Rota /api/config/stripe-key n√£o existe</li>
                            <li>STRIPE_PUBLISHABLE_KEY n√£o definida no .env</li>
                            <li>Arquivo .env n√£o foi carregado pelo backend</li>
                        </ul>
                    </div>

                    <div class="highlight">
                        <strong>Verifica√ß√µes necess√°rias:</strong><br>
                        1. Backend rodando na porta 3000<br>
                        2. Arquivo .env com STRIPE_PUBLISHABLE_KEY<br>
                        3. Rota de config registrada no server.js
                    </div>
                `, 'error');
            }
        }

        // 1. Teste de Conectividade
        async function testarConectividade() {
            try {
                mostrarResultado('conectividade-result', '‚è≥ Testando conectividade...', 'warning');

                const response = await fetch(`${API_BASE}/health`);

                if (response.ok) {
                    const data = await response.text();
                    mostrarResultado('conectividade-result', `
                        <h3>‚úÖ Backend Conectado!</h3>
                        <p><strong>URL:</strong> ${API_BASE}</p>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Response:</strong> ${data}</p>
                    `);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                mostrarResultado('conectividade-result', `
                    <h3>‚ùå Erro de Conectividade</h3>
                    <p><strong>URL:</strong> ${API_BASE}</p>
                    <p><strong>Erro:</strong> ${error.message}</p>
                    <div class="alert alert-error">
                        <strong>Solu√ß√£o:</strong> Verifique se o backend est√° rodando na porta 3000
                    </div>
                `, 'error');
            }
        }

        // 2. Teste de PaymentIntent
        async function testarPaymentIntent() {
            if (!STRIPE_PUBLIC_KEY) {
                mostrarResultado('payment-intent-result', `
                    <h3>‚ö†Ô∏è Configura√ß√µes Necess√°rias</h3>
                    <div class="alert alert-error">
                        Execute primeiro o teste 0 para carregar as configura√ß√µes do backend
                    </div>
                `, 'warning');
                return;
            }

            try {
                mostrarResultado('payment-intent-result', '‚è≥ Criando PaymentIntent...', 'warning');

                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Token de autentica√ß√£o n√£o encontrado. Fa√ßa login primeiro.');
                }

                const response = await fetch(`${API_BASE}/api/payment/create-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        amount: 19.99,
                        planName: 'teste-v4-dinamico',
                        credits: 1,
                        paymentMethod: 'card'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                currentClientSecret = data.clientSecret;

                mostrarResultado('payment-intent-result', `
                    <h3>‚úÖ PaymentIntent Criado!</h3>
                    <p><strong>Client Secret:</strong> ${data.clientSecret.substring(0, 30)}...</p>
                    <p><strong>Transaction ID:</strong> ${data.transactionId}</p>
                    <p><strong>Status:</strong> Pronto para Elements</p>
                    <div class="alert alert-success">
                        <strong>üéØ Pr√≥ximo passo:</strong> Execute o teste 3 (Elements) para verificar se as chaves s√£o compat√≠veis!
                    </div>
                `);

            } catch (error) {
                mostrarResultado('payment-intent-result', `
                    <h3>‚ùå Erro na Cria√ß√£o do PaymentIntent</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                    <div class="alert alert-error">
                        <strong>Dica:</strong> Verifique se voc√™ est√° logado e o backend est√° funcionando
                    </div>
                `, 'error');
            }
        }

        // 3. Teste de Stripe Elements (CR√çTICO)
        async function testarStripeElements() {
            if (!STRIPE_PUBLIC_KEY) {
                mostrarResultado('elements-result', `
                    <h3>‚ö†Ô∏è Configura√ß√µes Necess√°rias</h3>
                    <div class="alert alert-error">
                        Execute primeiro o teste 0 para carregar as configura√ß√µes do backend
                    </div>
                `, 'warning');
                return;
            }

            if (!currentClientSecret) {
                mostrarResultado('elements-result', `
                    <h3>‚ö†Ô∏è Client Secret Necess√°rio</h3>
                    <div class="alert alert-error">
                        Execute primeiro o teste 2 (PaymentIntent) para obter um client_secret
                    </div>
                `, 'warning');
                return;
            }

            try {
                mostrarResultado('elements-result', '‚è≥ Inicializando Stripe Elements...', 'warning');

                if (!stripe) {
                    console.log('üîß Stripe n√£o inicializado, inicializando com chave do backend...');
                    if (STRIPE_PUBLIC_KEY && typeof Stripe !== 'undefined') {
                        stripe = Stripe(STRIPE_PUBLIC_KEY);
                    } else {
                        throw new Error('Stripe.js n√£o dispon√≠vel ou chave inv√°lida');
                    }
                }

                if (typeof stripe.elements !== 'function') {
                    throw new Error('M√©todo stripe.elements n√£o est√° dispon√≠vel');
                }

                const container = document.getElementById('stripe-elements-container');
                container.innerHTML = '<div id="payment-element-test" style="min-height: 50px;"></div>';

                console.log('üîß Criando elements com client_secret:', currentClientSecret.substring(0, 30) + '...');
                console.log('üîß Usando chave do .env:', STRIPE_PUBLIC_KEY.substring(0, 20) + '...');

                const elements = stripe.elements({
                    clientSecret: currentClientSecret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#583819'
                        }
                    },
                    locale: 'pt-BR'
                });

                console.log('‚úÖ Elements criado:', elements);

                const paymentElement = elements.create('payment', {
                    layout: { type: 'tabs' }
                });

                console.log('‚úÖ PaymentElement criado:', paymentElement);

                // Event handlers
                paymentElement.on('ready', () => {
                    console.log('üéâ PaymentElement ready - SUCESSO TOTAL!');
                    mostrarResultado('elements-result', `
                        <h3>üéâ SUCESSO TOTAL!</h3>
                        <div class="alert alert-success">
                            <strong>‚úÖ RESULTADO:</strong> Stripe Elements funcionando perfeitamente!<br>
                            <strong>‚úÖ CONFIRMA√á√ÉO:</strong> N√£o h√° erro 401 - as chaves est√£o corretas!<br>
                            <strong>‚úÖ STATUS:</strong> Sistema de pagamento 100% operacional<br>
                            <strong>‚úÖ FONTE:</strong> Chaves carregadas do arquivo .env
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border: 2px solid #4CAF50; border-radius: 6px;">
                            <h4 style="color: #2e7d32; margin: 0 0 10px 0;">üéØ PROBLEMA RESOLVIDO!</h4>
                            <p style="margin: 0; color: #2e7d32;">As chaves do frontend (.env) e backend (.env) est√£o sincronizadas e funcionando corretamente.</p>
                        </div>
                    `, 'success');
                });

                paymentElement.on('loaderror', (event) => {
                    console.error('‚ùå ERRO 401 AINDA DETECTADO:', event);
                    mostrarResultado('elements-result', `
                        <h3>üö® ERRO 401 CONFIRMADO!</h3>
                        <p><strong>Erro:</strong> ${event.error?.message || 'Erro de autentica√ß√£o'}</p>
                        <p><strong>Tipo:</strong> ${event.error?.type || 'authentication_error'}</p>
                        <p><strong>C√≥digo:</strong> ${event.error?.code || '401'}</p>
                        
                        <div class="alert alert-error">
                            <h4>üîß SOLU√á√ÉO DEFINITIVA:</h4>
                            <ol>
                                <li><strong>Problema:</strong> Chaves do .env ainda incompat√≠veis</li>
                                <li><strong>Verificar:</strong> STRIPE_SECRET_KEY e STRIPE_PUBLISHABLE_KEY no .env</li>
                                <li><strong>Confirmar:</strong> Ambas chaves s√£o do mesmo projeto Stripe</li>
                                <li><strong>Gerar novas:</strong> <a href="https://dashboard.stripe.com/test/apikeys" target="_blank">Dashboard Stripe</a></li>
                                <li><strong>Reiniciar:</strong> Backend ap√≥s atualizar .env</li>
                            </ol>
                        </div>

                        <div class="highlight">
                            <strong>Chave atual (.env):</strong><br>
                            <code style="font-size: 11px; word-break: break-all;">${STRIPE_PUBLIC_KEY}</code>
                        </div>
                    `, 'error');
                });

                console.log('üîß Montando PaymentElement...');
                paymentElement.mount('#payment-element-test');
                console.log('‚úÖ PaymentElement montado');

            } catch (error) {
                console.error('‚ùå Erro cr√≠tico:', error);
                mostrarResultado('elements-result', `
                    <h3>‚ùå Erro na Inicializa√ß√£o</h3>
                    <p><strong>Erro:</strong> ${error.message}</p>
                    
                    <div style="margin-top: 15px;">
                        <h4>üîç Diagn√≥stico Completo:</h4>
                        <ul>
                            <li><strong>Stripe Object:</strong> ${stripe ? '‚úÖ Inicializado' : '‚ùå Null'}</li>
                            <li><strong>Stripe.js:</strong> ${typeof Stripe !== 'undefined' ? '‚úÖ Carregado' : '‚ùå N√£o carregado'}</li>
                            <li><strong>Elements Method:</strong> ${stripe && typeof stripe.elements === 'function' ? '‚úÖ Dispon√≠vel' : '‚ùå Indispon√≠vel'}</li>
                            <li><strong>Client Secret:</strong> ${currentClientSecret ? '‚úÖ Presente' : '‚ùå Ausente'}</li>
                            <li><strong>Chave P√∫blica (.env):</strong> ${STRIPE_PUBLIC_KEY ? '‚úÖ Definida' : '‚ùå Ausente'}</li>
                        </ul>
                    </div>

                    <div class="alert alert-error">
                        <h4>üîß A√ß√µes Recomendadas:</h4>
                        <ol>
                            <li>Execute primeiro o teste 0 (Carregar Config)</li>
                            <li>Verifique o .env do backend</li>
                            <li>Recarregue a p√°gina</li>
                            <li>Teste em aba an√¥nima</li>
                        </ol>
                    </div>
                `, 'error');
            }
        }

        // Auto-executar carregamento de configura√ß√µes
        window.addEventListener('load', () => {
            console.log('üöÄ Teste V4 carregado - configura√ß√£o din√¢mica do .env');
            setTimeout(() => {
                carregarConfiguracoes();
            }, 1000);
        });
    </script>
</body>

</html>