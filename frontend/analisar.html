<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Sem Frescura</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Header CSS -->
    <link rel="stylesheet" href="assets/css/header.css">

    <!-- Estilos do onboarding -->
    <link rel="stylesheet" href="/assets/css/onboarding.css">

    <script>
        // Autenticação desativada temporariamente para testes
        /*
        document.addEventListener('DOMContentLoaded', function() {
            // Pequeno atraso para garantir que  está carregado
            setTimeout(function() {
                if (!window.isAuthenticated || !window.isAuthenticated()) {
                    window.location.href = '#';
                }
            }, 50);
        });
        */
    </script>
    <style>
        :root {
            --primary: #583819;
            --primary-dark: #512808;
            --background: #F3EADA;
            --card-bg: #FFFCF9;
            --white: #FFFFFF;
            --text-dark: #583819;
            --text-gray: #505050;
            --border-color: #D1D1D1;
            --selected-file-bg: #ECD9B5;
            --border-radius: 10px;
            --shadow: 0px 4px 6px rgba(33, 33, 33, 0.04);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header styles removidos - agora gerenciados pelo header.js */

        /* Responsividade para o conteúdo principal */
        @media (max-width: 768px) {
            .main-content {
                padding: 5px 0;
            }
        }

        .main-content {
            padding: 10px 0;
            flex: 1 0 auto;
            margin-top: 0;
            padding-top: 100px;
            /* Espaço para o header fixo */
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .main-title {
            color: var(--text-dark);
            font-size: clamp(24px, 5vw, 35px);
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 5px;
        }

        .main-description {
            color: var(--text-gray);
            font-size: clamp(14px, 3vw, 17px);
            font-weight: 400;
            line-height: 1.5;
        }

        .upload-section {
            max-width: 802px;
            width: 95%;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .dropzone {
            width: 100%;
            height: auto;
            min-height: 150px;
            border: 1.5px dashed var(--primary);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 20px;
            transition: var(--transition);
            padding: 20px;
        }

        .dropzone:hover,
        .dropzone.active {
            background-color: rgba(88, 56, 25, 0.05);
        }

        .upload-icon {
            width: 42px;
            height: 28px;
            background: url('assets/img/icon-upload.svg') no-repeat center;
            background-size: contain;
            margin-bottom: 12px;
        }

        .upload-button {
            width: 205px;
            height: 37px;
            border-radius: 8px;
            border: 2px var(--primary) solid;
            background: transparent;
            position: relative;
            color: var(--primary);
            font-size: 13px;
            font-weight: 700;
            line-height: 25px;
            cursor: pointer;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-button::before {
            content: "+";
            width: auto;
            height: auto;
            left: 13px;
            top: 6px;
            position: absolute;
            background: transparent;
            color: var(--primary);
            font-size: 18px;
            font-weight: bold;
        }

        .dropzone-text {
            text-align: center;
            color: var(--text-gray);
            font-size: 14px;
            font-weight: 400;
            margin-top: 10px;
        }

        .file-input {
            display: none;
        }

        .selected-file {
            display: none;
            width: 100%;
            padding: 5px 19px;
            background-color: var(--selected-file-bg);
            border-radius: 5px;
            margin-top: 15px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: space-between;
        }

        .file-info {
            display: flex;
            align-items: center;
        }

        .file-icon {
            width: 18px;
            height: 16px;
            margin-right: 8px;
            background: url('assets/img/curriculo.svg') no-repeat center;
            background-size: contain;
        }

        .file-name {
            color: var(--primary);
            font-size: 12px;
            font-weight: 600;
            line-height: 18px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 50px);
        }

        .remove-file {
            width: 16px;
            height: 16px;
            min-width: 16px;
            background: url('assets/img/remover.svg') no-repeat center;
            background-size: contain;
            border: none;
            cursor: pointer;
        }

        .links-section {
            margin-top: 20px;
        }

        .links-section h2 {
            color: var(--text-gray);
            font-size: 13px;
            font-weight: 700;
            line-height: 24px;
            margin-bottom: 5px;
        }

        .job-links-container {
            margin-bottom: 10px;
        }

        .job-link-item {
            margin-bottom: 10px;
        }

        .job-link-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 11px;
            transition: var(--transition);
            width: 100%;
            max-width: 750px;
            box-sizing: border-box;
            font-family: 'IBM Plex Sans', sans-serif;
            color: var(--text-gray);
        }

        .job-link-input::placeholder {
            color: #505050;
            font-size: 11px;
            font-family: 'IBM Plex Sans', sans-serif;
            font-weight: 400;
            line-height: 18px;
            word-break: break-word;
        }

        .job-link-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .add-job-link-btn {
            background-color: transparent;
            color: var(--primary);
            border: none;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 5px;
            border-radius: 4px;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .add-job-link-btn:hover {
            background-color: rgba(88, 56, 25, 0.05);
        }

        .analyze-button-container {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            margin-bottom: 40px;
        }

        .analyze-button {
            width: 100%;
            max-width: 349px;
            height: 50px;
            background-color: var(--primary-dark);
            color: var(--white);
            border: none;
            border-radius: 7px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .analyze-button:hover {
            opacity: 0.9;
        }

        .features-section {
            background-color: var(--card-bg);
            padding: 40px 0;
            width: 100%;
        }

        .features-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .feature-item {
            width: 269px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
        }

        .feature-icon {
            width: 33px;
            height: 33px;
            background-color: var(--primary);
            border-radius: 3px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feature-icon.icon-ai {
            background: var(--primary) url('assets/img/icon-analysis.png') no-repeat center;
            background-size: 21px;
        }

        .feature-icon.icon-feedback {
            background: var(--primary) url('assets/img/icon-feedback.png') no-repeat center;
            background-size: 19px;
        }

        .feature-icon.icon-optimization {
            background: var(--primary) url('assets/img/icon-optimization.png') no-repeat center;
            background-size: 19px;
        }

        .feature-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .feature-desc {
            color: var(--text-gray);
            font-size: 17px;
            line-height: 1.5;
        }

        footer {
            background-color: var(--primary-dark);
            color: var(--white);
            padding: 20px 0;
            flex-shrink: 0;
            margin-top: auto;
        }

        .footer-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .footer-logo {
            height: 40px;
            width: auto;
        }

        .footer-links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-link:hover {
            color: var(--white);
        }

        .copyright {
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        @media (max-width: 992px) {
            .features-container {
                gap: 60px;
            }
        }

        @media (max-width: 768px) {
            .upload-section {
                padding: 15px;
            }

            .features-container {
                gap: 30px;
            }

            .feature-item {
                width: 100%;
                max-width: 320px;
            }

            .footer-container {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }

            .footer-links {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .main-title {
                font-size: 24px;
            }

            .main-description {
                font-size: 14px;
            }

            .upload-section {
                padding: 10px;
            }

            .dropzone {
                min-height: 120px;
                padding: 15px;
            }

            .upload-button {
                width: 180px;
                font-size: 12px;
            }

            .feature-item {
                padding: 5px;
            }
        }

        /* Novos estilos para a seção de 7 vagas obrigatórias */
        .vagas-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .vagas-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--selected-file-bg);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--primary);
        }

        .counter-icon {
            font-size: 16px;
        }

        .counter-text {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .counter-status {
            font-size: 12px;
            color: var(--text-gray);
            font-style: italic;
        }

        .strategy-explanation {
            background: linear-gradient(135deg, rgba(88, 56, 25, 0.05), rgba(236, 217, 181, 0.3));
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .strategy-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .strategy-content p {
            margin-bottom: 8px;
            line-height: 1.5;
            color: var(--text-dark);
        }

        .strategy-content p:first-child {
            font-weight: 600;
            color: var(--primary);
        }

        .strategy-content p:last-child {
            margin-bottom: 0;
            font-size: 14px;
        }

        .job-link-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 8px;
            transition: var(--transition);
        }

        .job-link-item:hover {
            background: rgba(88, 56, 25, 0.02);
        }

        .job-link-item.filled {
            background: rgba(88, 56, 25, 0.05);
            border: 1px solid rgba(88, 56, 25, 0.2);
        }

        .job-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--border-color);
            color: var(--text-gray);
            border-radius: 50%;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            transition: var(--transition);
        }

        .job-link-item.filled .job-number {
            background: var(--primary);
            color: white;
        }

        .job-link-item .job-link-input {
            margin: 0;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .job-link-item.filled .job-link-input {
            border-color: var(--primary);
            background: rgba(88, 56, 25, 0.02);
        }

        .vagas-progress {
            margin-top: 20px;
            padding: 16px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--selected-file-bg));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: 13px;
            color: var(--text-gray);
            margin: 0;
        }

        .progress-text.completed {
            color: var(--primary);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .vagas-header {
                gap: 8px;
            }

            .vagas-counter {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                padding: 10px 12px;
            }

            .strategy-explanation {
                padding: 12px;
                flex-direction: column;
                gap: 8px;
            }

            .strategy-icon {
                align-self: flex-start;
            }

            .job-link-item {
                gap: 8px;
                padding: 6px;
            }

            .job-number {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
        }
    </style>
    <script src="/assets/js/config.js?v=1750119001"></script>
    <!-- Logger Seguro -->
    <script src="/assets/js/lib/secure-logger.js"></script>
    <script src="/assets/js/auth.js?v=1750119000"></script>
    <script src="/assets/js/header-new.js?v=1748114561"></script>

    <!-- Script para mostrar menu logado INSTANTANEAMENTE -->
    <script>
        (function () {
            // Verificar IMEDIATAMENTE se usuário está logado
            function showLoggedUserInstantly() {
                const token = localStorage.getItem('token');
                const userDataStr = localStorage.getItem('user');

                if (token && userDataStr) {
                    try {
                        const userData = JSON.parse(userDataStr);
                        const guestActions = document.getElementById('guestActions');
                        const userMenuWrapper = document.getElementById('userMenuWrapper');
                        const userName = document.getElementById('userName');
                        const userCredits = document.getElementById('userCredits');

                        if (guestActions && userMenuWrapper) {
                            // Esconder menu de convidado
                            guestActions.style.display = 'none';

                            // Mostrar menu do usuário
                            userMenuWrapper.style.display = 'block';

                            // Atualizar nome
                            if (userName && userData.name) {
                                const firstName = userData.name.split(' ')[0];
                                userName.textContent = firstName;
                            }

                            // Atualizar créditos
                            if (userCredits) {
                                const credits = userData.credits || 0;
                                userCredits.textContent = `${credits} análise${credits !== 1 ? 's' : ''}`;
                                userCredits.style.cssText = `
                                    background: #583819 !important;
                                    color: white !important;
                                    padding: 0.25rem 0.5rem !important;
                                    border-radius: 0.375rem !important;
                                    font-size: 0.75rem !important;
                                    font-weight: 600 !important;
                                `;
                            }

                            console.log('⚡ Menu logado exibido INSTANTANEAMENTE na página analisar');
                        }
                    } catch (error) {
                        console.log('Erro ao processar dados do usuário:', error);
                    }
                } else {
                    // Não logado - mostrar menu de convidado
                    const guestActions = document.getElementById('guestActions');
                    const userMenuWrapper = document.getElementById('userMenuWrapper');

                    if (guestActions && userMenuWrapper) {
                        guestActions.style.display = 'flex';
                        userMenuWrapper.style.display = 'none';
                    }
                }
            }

            // Executar IMEDIATAMENTE
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', showLoggedUserInstantly);
            } else {
                showLoggedUserInstantly();
            }
        })();
    </script>
    <script>
        // Função global para mostrar notificações
        window.showNotification = function (message, type = 'info') {
            // Criar elemento de notificação se não existir
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    max-width: 300px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(notification);
            }

            // Definir cor baseada no tipo
            const colors = {
                success: '#583819',
                error: '#F44336',
                info: '#2196F3',
                warning: '#FF9800'
            };

            notification.style.backgroundColor = colors[type] || colors.info;
            notification.textContent = message;
            notification.style.display = 'block';

            // Remover após 5 segundos
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        };

        // Função para validar código ANTES do login/cadastro
        function validateGiftCodeBeforeAuth(code) {
            return fetch('/api/gift-code/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code: code })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        showGiftCodeWelcomeModal(code, data.credits);
                        return true;
                    } else {
                        showGiftCodeErrorModal(data.error || 'Código inválido');
                        return false;
                    }
                })
                .catch(error => {
                    console.error('Erro ao validar código:', error);
                    showGiftCodeErrorModal('Erro de conexão. Verifique sua internet e tente novamente.');
                    return false;
                });
        }

        // Função para mostrar modal de boas-vindas com código válido
        function showGiftCodeWelcomeModal(code, credits) {
            const modalHTML = `
                <div id="giftCodeWelcomeModal" onclick="if(event.target === this) window.location.href='landing.html'" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.7); display: flex; align-items: center; 
                    justify-content: center; z-index: 10000; cursor: pointer;
                ">
                    <div style="
                        background: white; border-radius: 20px; max-width: 550px; width: 90%;
                        box-shadow: 0 25px 50px rgba(0,0,0,0.4); animation: modalSlideIn 0.4s ease;
                        overflow: hidden; position: relative; cursor: default;
                    ">
                        <button onclick="closeGiftCodeWelcomeModal()" style="
                            position: absolute; top: 16px; right: 20px; background: rgba(255,255,255,0.2); 
                            border: none; font-size: 24px; color: white; cursor: pointer; 
                            width: 36px; height: 36px; display: flex; align-items: center; 
                            justify-content: center; border-radius: 50%; transition: all 0.2s; z-index: 1;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
                        <!-- Header com gradiente -->
                        <div style="
                            background: linear-gradient(135deg, #583819, #8B4513);
                            color: white; padding: 2rem; text-align: center;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">🎁</div>
                            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">
                                Código Válido!
                            </h2>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 1rem;">
                                Você ganhou ${credits} análise${credits > 1 ? 's' : ''} completa${credits > 1 ? 's' : ''}!
                            </p>
                        </div>

                        <!-- Conteúdo -->
                        <div style="padding: 2rem;">
                            <div style="
                                background: #f8f9ff; border: 2px solid #e1e8ff; 
                                border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;
                            ">
                                <h3 style="color: #583819; margin: 0 0 1rem 0; font-size: 1.1rem;">
                                    ✨ O que você ganha:
                                </h3>
                                <ul style="margin: 0; padding-left: 1.5rem; color: #666; line-height: 1.8;">
                                    <li><strong>Análise completa</strong> do seu currículo</li>
                                    <li><strong>Exatamente 7 vagas</strong> por análise</li>
                                    <li><strong>Feedback personalizado</strong> com IA</li>
                                    <li><strong>Otimização profissional</strong> para cada vaga</li>
                                </ul>
                            </div>

                            <p style="text-align: center; color: #666; margin-bottom: 1.5rem; line-height: 1.6;">
                                Para usar seu código, você precisa ter uma conta.<br>
                                <strong>É rápido e gratuito!</strong>
                            </p>

                            <!-- Botões de ação -->
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <button onclick="showRegisterForGiftCode('${code}')" style="
                                    padding: 0.75rem 1.5rem; background: #583819; color: white;
                                    border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
                                    font-size: 1rem; min-width: 140px; transition: all 0.2s;
                                " onmouseover="this.style.background='#4a2f15'" onmouseout="this.style.background='#583819'">
                                    📝 Criar Conta
                                </button>
                                <button onclick="showLoginForGiftCode('${code}')" style="
                                    padding: 0.75rem 1.5rem; border: 2px solid #583819; 
                                    background: transparent; color: #583819; border-radius: 8px;
                                    cursor: pointer; font-weight: 600; font-size: 1rem; min-width: 140px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                                    🔐 Já tenho conta
                                </button>
                            </div>

                            <p style="text-align: center; margin-top: 1rem; font-size: 0.85rem; color: #888;">
                                💡 Seu código <strong>${code}</strong> será aplicado automaticamente após o login
                            </p>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes modalSlideIn {
                        from { transform: translateY(-30px) scale(0.95); opacity: 0; }
                        to { transform: translateY(0) scale(1); opacity: 1; }
                    }
                </style>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Salvar código para aplicar após login/cadastro
            localStorage.setItem('pendingGiftCode', code);
            localStorage.setItem('isGiftCodeUser', 'true');
        }

        // Função para mostrar cadastro com contexto de código
        window.showRegisterForGiftCode = function (code) {
            closeGiftCodeWelcomeModal();
            setTimeout(() => {
                const authModal = document.getElementById('authModal');
                if (authModal) {
                    authModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';

                    // 🎨 UX: Aplicar blur suave no conteúdo da página com transição
                    const mainContent = document.querySelector('.main-content');
                    const header = document.querySelector('header');
                    if (mainContent) {
                        mainContent.style.transition = 'filter 0.3s ease';
                        mainContent.style.filter = 'blur(3px)';
                    }
                    if (header) {
                        header.style.transition = 'filter 0.3s ease';
                        header.style.filter = 'blur(3px)';
                    }

                    // Mostrar formulário de cadastro
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('registerForm').style.display = 'block';
                    document.getElementById('authModalTitle').textContent = 'Criar Conta para Usar o Código';

                    // Adicionar mensagem motivacional
                    let motivationMsg = document.getElementById('giftCodeMotivation');
                    if (!motivationMsg) {
                        motivationMsg = document.createElement('div');
                        motivationMsg.id = 'giftCodeMotivation';
                        motivationMsg.style.cssText = `
                            background: linear-gradient(135deg, #583819, #8B4513);
                            color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;
                            text-align: center; font-size: 0.9rem;
                        `;
                        motivationMsg.innerHTML = `
                            🎁 <strong>Código ${code}</strong> - 1 análise completa gratuita!<br>
                            <small>Crie sua conta para ativar o benefício</small>
                        `;
                        document.getElementById('registerForm').insertBefore(motivationMsg, document.getElementById('registerForm').firstChild);
                    }
                }
            }, 300);
        };

        // Função para fechar modal de boas-vindas com opção de redirecionar
        window.closeGiftCodeWelcomeModal = function (redirect = true) {
            const modal = document.getElementById('giftCodeWelcomeModal');
            if (modal) modal.remove();
            // Somente redirecionar se explicitamente solicitado
            if (redirect) {
                // Se houver parâmetro returnTo manter, senão ficar na mesma página
                window.location.href = 'landing.html';
            }
        };

        // Função para mostrar login com contexto de código
        window.showLoginForGiftCode = function (code) {
            // Fechar modal sem redirecionar
            closeGiftCodeWelcomeModal(false);
            setTimeout(() => {
                const authModal = document.getElementById('authModal');
                if (authModal) {
                    authModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';

                    // 🎨 UX: Aplicar blur suave no conteúdo da página com transição
                    const mainContent = document.querySelector('.main-content');
                    const header = document.querySelector('header');
                    if (mainContent) {
                        mainContent.style.transition = 'filter 0.3s ease';
                        mainContent.style.filter = 'blur(3px)';
                    }
                    if (header) {
                        header.style.transition = 'filter 0.3s ease';
                        header.style.filter = 'blur(3px)';
                    }

                    // Mostrar formulário de login
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('registerForm').style.display = 'none';
                    document.getElementById('authModalTitle').textContent = 'Entrar para Usar o Código';

                    // Adicionar mensagem motivacional
                    let motivationMsg = document.getElementById('giftCodeMotivation');
                    if (!motivationMsg) {
                        motivationMsg = document.createElement('div');
                        motivationMsg.id = 'giftCodeMotivation';
                        motivationMsg.style.cssText = `
                            background: linear-gradient(135deg, #583819, #8B4513);
                            color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;
                            text-align: center; font-size: 0.9rem;
                        `;
                        motivationMsg.innerHTML = `
                            🎁 <strong>Código ${code}</strong> - 1 análise completa gratuita!<br>
                            <small>Faça login para ativar o benefício</small>
                        `;
                        document.getElementById('loginForm').insertBefore(motivationMsg, document.getElementById('loginForm').firstChild);
                    }
                }
            }, 300);
        };

        // Função para aplicar código de presente após autenticação
        function applyGiftCodeAfterAuth(code) {
            console.log('🎁 Iniciando aplicação do código:', code);

            // Verificar se este código já foi aplicado nesta sessão para evitar duplicação
            const appliedCodes = JSON.parse(sessionStorage.getItem('appliedGiftCodes') || '[]');
            if (appliedCodes.includes(code)) {
                console.log('🔄 Código já aplicado nesta sessão:', code);
                return;
            }

            // 🚨 PROTEÇÃO ANTI-TRAVAMENTO: Timeout de segurança para que a função nunca trave
            const safetyTimeout = setTimeout(() => {
                console.log('⚠️ SAFETY TIMEOUT: applyGiftCodeAfterAuth demorou muito, continuando...');
                // Se a função demorar mais de 8 segundos, algo deu errado, mas não travamos
            }, 8000);

            fetch('/api/gift-code/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${auth.getToken()}`
                },
                body: JSON.stringify({ code: code })
            })
                .then(response => {
                    // Verificar se é erro 401 (não autenticado)
                    if (response.status === 401) {
                        showNotification('Sessão expirada. Faça login novamente.', 'warning');
                        // Limpar autenticação e recarregar página
                        auth.logout();
                        return null;
                    }

                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Se foi erro 401, data será null

                    if (data.success) {
                        // Marcar código como aplicado nesta sessão
                        const appliedCodes = JSON.parse(sessionStorage.getItem('appliedGiftCodes') || '[]');
                        appliedCodes.push(code);
                        sessionStorage.setItem('appliedGiftCodes', JSON.stringify(appliedCodes));

                        // Mostrar notificação de sucesso
                        showNotification(data.message || 'Código aplicado com sucesso!', 'success');
                        // Atualizar créditos na interface
                        const user = auth.getUser();
                        if (user) {
                            user.credits = data.credits;
                            localStorage.setItem('user', JSON.stringify(user));
                            // Header será atualizado automaticamente pelo header.js
                        }
                        // Limpar código após uso bem-sucedido
                        localStorage.removeItem('giftCode');
                        localStorage.removeItem('pendingGiftCode');

                        // Limpar timeout de segurança
                        clearTimeout(safetyTimeout);
                        console.log('✅ Código aplicado com sucesso, limpando timeout');
                    } else {
                        // Verificar se é erro de código já utilizado
                        if (data.error && (data.error.includes('já foi utilizado') || data.error.includes('já utilizou') || data.error.includes('inválido ou não pode ser utilizado'))) {
                            showGiftCodeErrorModal(data.error);

                            // Limpar todos os dados relacionados ao código
                            localStorage.removeItem('giftCode');
                            localStorage.removeItem('pendingGiftCode');
                            localStorage.removeItem('isGiftCodeUser');

                            // Se for acesso direto sem login prévio, mostrar modal de login após um tempo
                            if (!auth.isAuthenticated() && (data.error.includes('já utilizou') || data.error.includes('já foi utilizado'))) {
                                setTimeout(() => {
                                    // Fechar modal de erro primeiro
                                    closeGiftCodeModal();
                                    // Mostrar modal de autenticação
                                    setTimeout(() => {
                                        const authModal = document.getElementById('authModal');
                                        if (authModal) {
                                            authModal.style.display = 'flex';
                                            document.body.style.overflow = 'hidden';
                                            // Mostrar formulário de login
                                            document.getElementById('loginForm').style.display = 'block';
                                            document.getElementById('registerForm').style.display = 'none';
                                            document.getElementById('authModalTitle').textContent = 'Entrar';
                                        }
                                    }, 500);
                                }, 3000);
                            }
                        } else {
                            showGiftCodeErrorModal(data.error || 'Erro inesperado ao aplicar código de presente.');
                            // Limpar código em caso de erro genérico
                            localStorage.removeItem('giftCode');
                            localStorage.removeItem('pendingGiftCode');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao aplicar código:', error);
                    showGiftCodeErrorModal('Erro de conexão. Verifique sua internet e tente novamente.');

                    // Limpar timeout de segurança
                    clearTimeout(safetyTimeout);
                    console.log('❌ Erro na aplicação, limpando timeout');
                });
        }

        // Função para limpar códigos inválidos do localStorage
        function cleanupInvalidGiftCodes() {
            const giftCode = localStorage.getItem('giftCode');
            const pendingGiftCode = localStorage.getItem('pendingGiftCode');

            // Remover códigos vazios ou inválidos
            if (giftCode && giftCode.trim() === '') {
                localStorage.removeItem('giftCode');
            }
            if (pendingGiftCode && pendingGiftCode.trim() === '') {
                localStorage.removeItem('pendingGiftCode');
            }
        }

        // Função adicional para limpar dados de código quando acesso direto sem código na URL
        function cleanupGiftCodeDataIfNoUrlCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const giftCodeFromUrl = urlParams.get('giftCode');

            // Se não há código na URL, limpar dados antigos para evitar processamento indevido
            if (!giftCodeFromUrl) {
                const hasOldCode = localStorage.getItem('giftCode') || localStorage.getItem('pendingGiftCode');
                if (hasOldCode) {
                    console.log('Limpando dados antigos de código de presente - acesso direto sem código na URL');
                    localStorage.removeItem('giftCode');
                    localStorage.removeItem('pendingGiftCode');
                    // Não remover isGiftCodeUser aqui pois pode ser um usuário legítimo que já usou o código
                }
            }
        }

        // Limpar códigos inválidos ao carregar a página
        cleanupInvalidGiftCodes();
        // Limpar dados antigos se não há código na URL
        cleanupGiftCodeDataIfNoUrlCode();

        // Função para mostrar modal específico baseado no tipo de erro
        function showGiftCodeErrorModal(errorMessage) {
            // Analisar o tipo de erro para personalizar a resposta
            let title, message, actions;

            if (errorMessage.includes('já utilizou') || errorMessage.includes('já foi utilizado')) {
                title = '🎁 Código Já Utilizado';
                message = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🎁</div>
                        <h3 style="color: #583819; margin-bottom: 16px;">Este código já foi utilizado</h3>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 20px;">
                            Você já resgatou este código de presente anteriormente. <br>
                            Cada código pode ser usado apenas uma vez por pessoa.
                        </p>
                        <div style="background: #f8f9ff; border: 1px solid #e1e8ff; border-radius: 8px; padding: 16px; margin: 16px 0;">
                            <strong style="color: #583819;">💡 O que você pode fazer:</strong>
                            <ul style="text-align: left; margin: 8px 0; padding-left: 20px; color: #666;">
                                <li>Verifique se você tem análises disponíveis em seu perfil</li>
                                <li>Considere adquirir um plano para mais análises</li>
                                <li>Compartilhe nosso serviço para ganhar novos códigos</li>
                            </ul>
                        </div>
                    </div>
                `;
                actions = `
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                        <button onclick="closeGiftCodeModal()" style="
                            padding: 12px 24px; border: 2px solid #583819; background: transparent; 
                            color: #583819; border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">Entendi</button>
                        <button onclick="window.location.href='payment.html'" style="
                            padding: 12px 24px; background: #583819; color: white; border: none; 
                            border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">Ver Planos 🚀</button>
                    </div>
                `;
            } else if (errorMessage.includes('esgotado')) {
                title = '📋 Código Esgotado';
                message = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                        <h3 style="color: #583819; margin-bottom: 16px;">Código esgotado</h3>
                        <p style="color: #666; line-height: 1.6;">
                            Este código de presente atingiu o limite máximo de usos. <br>
                            Infelizmente não é mais possível utilizá-lo.
                        </p>
                    </div>
                `;
                actions = `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeGiftCodeModal()" style="
                            padding: 12px 24px; background: #583819; color: white; border: none; 
                            border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">Entendi</button>
                    </div>
                `;
            } else if (errorMessage.includes('expirado')) {
                title = '⏰ Código Expirado';
                message = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">⏰</div>
                        <h3 style="color: #583819; margin-bottom: 16px;">Código expirado</h3>
                        <p style="color: #666; line-height: 1.6;">
                            Este código de presente passou do prazo de validade. <br>
                            Não é mais possível utilizá-lo.
                        </p>
                    </div>
                `;
                actions = `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeGiftCodeModal()" style="
                            padding: 12px 24px; background: #583819; color: white; border: none; 
                            border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">Entendi</button>
                    </div>
                `;
            } else {
                title = '❌ Código Inválido';
                message = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">❌</div>
                        <h3 style="color: #583819; margin-bottom: 16px;">Código não encontrado</h3>
                        <p style="color: #666; line-height: 1.6;">
                            Este código de presente não foi encontrado em nosso sistema. <br>
                            Verifique se foi digitado corretamente.
                        </p>
                    </div>
                `;
                actions = `
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeGiftCodeModal()" style="
                            padding: 12px 24px; background: #583819; color: white; border: none; 
                            border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">Tentar Novamente</button>
                    </div>
                `;
            }

            // Criar e mostrar modal
            const modalHTML = `
                <div id="giftCodeErrorModal" onclick="if(event.target === this) window.location.href='landing.html'" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.6); display: flex; align-items: center; 
                    justify-content: center; z-index: 10000; cursor: pointer;
                ">
                    <div style="
                        background: white; border-radius: 16px; max-width: 500px; width: 90%;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease;
                        position: relative; cursor: default;
                    ">
                        <button onclick="closeGiftCodeModal()" style="
                            position: absolute; top: 12px; right: 16px; background: none; 
                            border: none; font-size: 24px; color: #999; cursor: pointer; 
                            width: 32px; height: 32px; display: flex; align-items: center; 
                            justify-content: center; border-radius: 50%; transition: all 0.2s;
                        " onmouseover="this.style.background='#f5f5f5'; this.style.color='#666';" 
                           onmouseout="this.style.background='none'; this.style.color='#999';">×</button>
                        ${message}
                        ${actions}
                    </div>
                </div>
                <style>
                    @keyframes modalSlideIn {
                        from { transform: translateY(-50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Função para fechar modal
        window.closeGiftCodeModal = function () {
            const modal = document.getElementById('giftCodeErrorModal');
            if (modal) modal.remove();
            // Redirecionar para a landing
            window.location.href = 'landing.html';
        };

        // Função global para liberar a página após login
        window.authSuccess = function () {
            console.log('🎉 authSuccess() chamada - início');

            // Verificar se há um parâmetro returnTo na URL
            const urlParams = new URLSearchParams(window.location.search);
            const returnTo = urlParams.get('returnTo');

            if (returnTo) {
                console.log('🔄 Redirecionando para:', returnTo);
                // Redirecionar para a página solicitada
                window.location.href = returnTo;
                return;
            }

            // 🔧 CORREÇÃO: Limpar parâmetro login=true da URL após login bem-sucedido
            const loginParam = urlParams.get('login');
            if (loginParam === 'true') {
                console.log('🧹 Limpando parâmetro login=true da URL');
                urlParams.delete('login');
                const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                window.history.replaceState({}, document.title, newUrl);
            }

            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.display = '';
                // 🎨 UX: Remover blur do conteúdo
                mainContent.style.filter = '';
            }
            const footer = document.querySelector('footer');
            if (footer) footer.style.display = '';
            const header = document.querySelector('header');
            if (header) header.style.filter = ''; // Remover blur do header

            document.getElementById('authModal').style.display = 'none';
            document.body.style.overflow = '';

            console.log('🔄 Forçando refresh do header...');
            // Forçar atualização do header após login bem-sucedido
            if (window.refreshHeader) {
                window.refreshHeader();
            }

            console.log('🔄 Agendando updateAnalyzeButton após authSuccess...');
            // Garantir que updateAnalyzeButton seja chamada com delay adequado para evitar banner prematuramente
            setTimeout(() => {
                if (window.updateAnalyzeButton) {
                    window.updateAnalyzeButton();
                }
            }, 800);

            console.log('✅ authSuccess() finalizada');
        };

        // Função global para alternar para o formulário de cadastro
        function switchToRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('authModalTitle').textContent = 'Cadastrar';
            document.getElementById('authError').style.display = 'none';
            // Preencher o email se foi digitado no formulário de login
            const loginEmail = document.getElementById('loginEmail').value;
            if (loginEmail) {
                document.getElementById('registerEmail').value = loginEmail;
            }
        }

        // Função global para atualizar créditos após ações que consomem créditos
        window.onAnalysisComplete = function () {
            // Atualizar créditos no header após análise
            if (window.updateHeaderCredits) {
                console.log('📊 Atualizando créditos após análise completada');
                window.updateHeaderCredits();
            }
            // Atualizar botão de análise
            if (window.updateAnalyzeButton) {
                setTimeout(window.updateAnalyzeButton, 500);
            }
        };

        // Função global para atualizar após pagamento
        window.onPaymentComplete = function () {
            // Atualizar créditos no header após compra
            if (window.updateHeaderCredits) {
                console.log('💳 Atualizando créditos após pagamento');
                window.updateHeaderCredits();
            }
            // Atualizar botão de análise
            if (window.updateAnalyzeButton) {
                setTimeout(window.updateAnalyzeButton, 500);
            }
        };
    </script>
</head>

<body>
    <!-- Header Inline (aparece instantaneamente) -->
    <header class="header" id="header" style="
        position: sticky; top: 0; z-index: 50; 
        background: rgba(250, 249, 247, 0.95); 
        backdrop-filter: blur(12px); 
        border-bottom: 1px solid #e8ddd0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    ">
        <div style="
            display: flex; align-items: center; justify-content: space-between; 
            height: 80px; max-width: 1280px; margin: 0 auto; 
            padding: 0 1.5rem; gap: 2rem;
        ">
            <div>
                <a href="landing.html">
                    <img src="assets/img/logo.png" alt="RH Super Sincero" style="height: 48px; width: auto;">
                </a>
            </div>
            <nav style="display: flex; gap: 2rem;" id="headerNav">
                <a href="landing.html" style="
                    color: #3f3f46; text-decoration: none; font-weight: 500; 
                    font-size: 0.95rem; padding: 0.5rem 0; transition: color 0.15s;
                " onmouseover="this.style.color='#583819'" onmouseout="this.style.color='#3f3f46'">Início</a>
                <a href="analisar.html" style="
                    color: #3f3f46; text-decoration: none; font-weight: 500; 
                    font-size: 0.95rem; padding: 0.5rem 0; transition: color 0.15s;
                " onmouseover="this.style.color='#583819'" onmouseout="this.style.color='#3f3f46'">Analisar</a>
                <a href="payment.html" style="
                    color: #3f3f46; text-decoration: none; font-weight: 500; 
                    font-size: 0.95rem; padding: 0.5rem 0; transition: color 0.15s;
                " onmouseover="this.style.color='#583819'" onmouseout="this.style.color='#3f3f46'">Planos</a>
            </nav>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <div id="guestActions" style="display: none; gap: 0.75rem; align-items: center;">
                    <a href="#gift-code" style="
                        display: inline-flex; align-items: center; gap: 0.5rem;
                        padding: 0.5rem 1rem; background: #f4f0ea; color: #583819;
                        border-radius: 0.5rem; text-decoration: none; font-weight: 600; font-size: 0.8rem;
                    ">
                        <span>🎓</span>
                        <span>Código de Presente</span>
                    </a>
                    <a href="analisar.html?login=true" style="
                        display: inline-flex; align-items: center; gap: 0.5rem;
                        padding: 0.5rem 1rem; background: transparent; color: #3f3f46;
                        border: 1px solid #d4d4d8; border-radius: 0.5rem; text-decoration: none; 
                        font-weight: 600; font-size: 0.8rem;
                    ">
                        <span>🔐</span>
                        <span>Entrar</span>
                    </a>
                    <a href="payment.html" style="
                        display: inline-flex; align-items: center; gap: 0.5rem;
                        padding: 0.5rem 1rem; background: #583819; color: white;
                        border-radius: 0.5rem; text-decoration: none; font-weight: 600; font-size: 0.8rem;
                    ">
                        <span>💳</span>
                        <span>Comprar</span>
                    </a>
                </div>
                <div id="userMenuWrapper" style="display: none; position: relative;">
                    <a href="#" id="authButton" style="
                        display: flex; align-items: center; gap: 0.75rem;
                        background: #f4f0ea; padding: 0.5rem 1rem; border-radius: 0.75rem;
                        text-decoration: none; color: inherit;
                    ">
                        <span id="userName" style="font-weight: 500; color: #583819;">Usuário</span>
                        <span id="userCredits" style="
                            background: #583819; color: white; padding: 0.25rem 0.5rem;
                            border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;
                        ">0 análises</span>
                        <span style="font-size: 0.7rem; color: #583819;">▼</span>
                    </a>
                    <div id="userDropdown" style="
                        position: absolute; top: 100%; right: 0; margin-top: 0.5rem;
                        background: white; border-radius: 0.5rem; min-width: 200px; z-index: 999;
                        display: none; border: 1px solid #e5e7eb; overflow: hidden;
                        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
                    ">
                        <a href="analisar.html" style="
                            display: block; padding: 0.75rem 1rem; color: #3f3f46; text-decoration: none;
                            font-size: 0.875rem; border: none; width: 100%; text-align: left;
                        ">📊 Analisar Currículo</a>
                        <a href="history.html" style="
                            display: block; padding: 0.75rem 1rem; color: #3f3f46; text-decoration: none;
                            font-size: 0.875rem; border: none; width: 100%; text-align: left;
                        ">📋 Histórico</a>
                        <a href="payment.html" style="
                            display: block; padding: 0.75rem 1rem; color: #3f3f46; text-decoration: none;
                            font-size: 0.875rem; border: none; width: 100%; text-align: left;
                        ">💳 Comprar análises</a>
                        <a href="#" id="logoutButton" style="
                            display: block; padding: 0.75rem 1rem; color: #dc3545; text-decoration: none;
                            font-size: 0.875rem; border: none; width: 100%; text-align: left;
                            border-top: 1px solid #e5e7eb;
                        ">🚪 Sair</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Modal de Login/Cadastro - UX Aprimorada -->
    <div id="authModal" class="modal" style="display:flex; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; 
               background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
               align-items:center; justify-content:center; transition:all 0.3s ease;">
        <div
            style="background:#fff; border-radius:18px; max-width:380px; width:92vw; padding:32px 22px 24px 22px; box-shadow:0 8px 32px #0003; position:relative; display:flex; flex-direction:column; align-items:center;">
            <img src="assets/img/logo.png" alt="RH Super Sincero"
                style="width:110px; margin-bottom:18px; display:block;">
            <button id="closeAuthModal"
                style="position:absolute; right:18px; top:14px; background:none; border:none; font-size:22px; color:#583819; cursor:pointer;">×</button>
            <h2 id="authModalTitle"
                style="font-family:'IBM Plex Sans',sans-serif; color:#583819; font-size:1.4em; font-weight:700; margin-bottom:18px;">
                Entrar</h2>
            <form id="loginForm" style="display:block; width:100%;">
                <input type="email" id="loginEmail" placeholder="E-mail" required
                    style="margin-bottom:12px; width:100%; padding:10px 12px; border:1.5px solid #ECD9B5; border-radius:7px; font-size:1em;">
                <input type="password" id="loginPassword" placeholder="Senha" required
                    style="margin-bottom:12px; width:100%; padding:10px 12px; border:1.5px solid #ECD9B5; border-radius:7px; font-size:1em;">
                <button type="submit"
                    style="width:100%; background:linear-gradient(90deg,#583819,#ECD9B5); color:#fff; border:none; padding:11px; border-radius:7px; font-weight:700; font-size:1em; margin-bottom:8px; box-shadow:0 2px 8px #58381922;">Entrar</button>
                <p style="margin:8px 0 4px 0; font-size:14px; text-align:center;">Não tem conta? <a href="#"
                        id="showRegister" style="color:#583819; font-weight:600;">Cadastre-se</a></p>
                <p style="margin:0; font-size:13px; text-align:center;">
                    <a href="forgot-password.html" style="color:#666; text-decoration:none;">🔐 Esqueci minha senha</a>
                </p>
            </form>
            <form id="registerForm" style="display:none; width:100%;">
                <input type="text" id="registerName" placeholder="Nome completo" required
                    style="margin-bottom:12px; width:100%; padding:10px 12px; border:1.5px solid #ECD9B5; border-radius:7px; font-size:1em;">
                <input type="email" id="registerEmail" placeholder="E-mail" required
                    style="margin-bottom:12px; width:100%; padding:10px 12px; border:1.5px solid #ECD9B5; border-radius:7px; font-size:1em;">
                <input type="password" id="registerPassword" placeholder="Senha" required
                    style="margin-bottom:12px; width:100%; padding:10px 12px; border:1.5px solid #ECD9B5; border-radius:7px; font-size:1em;">
                <button type="submit"
                    style="width:100%; background:linear-gradient(90deg,#583819,#ECD9B5); color:#fff; border:none; padding:11px; border-radius:7px; font-weight:700; font-size:1em; margin-bottom:8px; box-shadow:0 2px 8px #58381922;">Cadastrar</button>
                <p style="margin:8px 0 0 0; font-size:14px; text-align:center;">Já tem conta? <a href="#" id="showLogin"
                        style="color:#583819; font-weight:600;">Entrar</a></p>
            </form>
            <p id="authError" style="color:#b22; font-size:14px; text-align:center; margin-top:10px; display:none;"></p>
        </div>
    </div>

    <!-- Header será carregado dinamicamente pelo header.js -->

    <!-- Onboarding Overlay -->
    <main class="main-content">
        <div class="container">
            <section class="header-section">
                <h1 class="main-title">Analisar Currículo com IA</h1>
                <p class="main-description">
                    Nossa inteligência artificial analisa seu currículo e otimiza para 7 vagas específicas
                </p>
            </section>

            <!-- Banner de Status de Créditos -->
            <div id="creditsStatusBanner" style="
                background: linear-gradient(135deg, #ff9800, #ff6b35);
                color: white; padding: 16px 24px; margin-bottom: 25px;
                border-radius: 12px; display: none; align-items: center; justify-content: space-between;
                box-shadow: 0 4px 16px rgba(255, 152, 0, 0.25);
                border: 1px solid rgba(255, 255, 255, 0.2);
            ">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="
                        background: rgba(255, 255, 255, 0.2); 
                        border-radius: 50%; width: 48px; height: 48px;
                        display: flex; align-items: center; justify-content: center;
                        font-size: 1.5em;
                    ">⚡</div>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 4px;">
                            <span id="creditsStatusText">Você não tem análises disponíveis</span>
                        </div>
                        <div style="font-size: 0.95em; opacity: 0.9;">
                            <span id="creditsStatusDescription">Compre créditos para analisar seu currículo com nossa
                                IA</span>
                        </div>
                    </div>
                </div>
                <button onclick="window.location.href='payment.html'" style="
                    background: white; color: #ff6b35; border: none; padding: 12px 24px;
                    border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1em;
                    transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    white-space: nowrap;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                    💳 Comprar Análises
                </button>
            </div>

            <div class="upload-section">
                <div class="dropzone" id="dropzone">
                    <div class="upload-icon"></div>
                    <button class="upload-button" id="selectFileBtn" type="button">Selecione Seu Currículo</button>
                    <p class="dropzone-text">Ou arraste e solte seu currículo nesse campo</p>
                    <input type="file" class="file-input" id="fileInput" accept=".pdf,.docx" style="display:none;">
                </div>

                <div class="selected-file" id="selectedFile">
                    <div class="file-info">
                        <div class="file-icon"></div>
                        <span class="file-name">Nome do arquivo</span>
                    </div>
                    <button class="remove-file" aria-label="Remover arquivo"></button>
                </div>

                <div class="links-section">
                    <div class="vagas-header">
                        <h2>Link das Vagas Desejadas</h2>
                        <div class="vagas-counter" id="vagasCounter">
                            <span class="counter-icon">📋</span>
                            <span class="counter-text">Vagas preenchidas: <span id="currentCount">0</span>/7</span>
                            <span class="counter-status" id="counterStatus">(Recomendado: até 7 vagas)</span>
                        </div>
                    </div>

                    <div class="strategy-explanation">
                        <div class="strategy-icon">💡</div>
                        <div class="strategy-content">
                            <p><strong>Por que recomendamos até 7 vagas?</strong></p>
                            <p>Sistemas como Gupy limitam candidaturas a no máximo 7 vagas por ciclo de 7-10 dias. Você
                                pode
                                enviar menos vagas, mas para análises mais precisas e estratégicas, recomendamos usar o
                                limite máximo de <strong>7 vagas</strong> por análise.</p>
                        </div>
                    </div>

                    <div class="job-links-container" id="jobLinksContainer">
                        <div class="job-link-item">
                            <span class="job-number">1</span>
                            <input type="url" class="job-link-input" placeholder="https://linkdavaga1.com" id="jobLink1"
                                autocomplete="off">
                        </div>
                        <div class="job-link-item">
                            <span class="job-number">2</span>
                            <input type="url" class="job-link-input" placeholder="https://linkdavaga2.com" id="jobLink2"
                                autocomplete="off">
                        </div>
                        <div class="job-link-item">
                            <span class="job-number">3</span>
                            <input type="url" class="job-link-input" placeholder="https://linkdavaga3.com" id="jobLink3"
                                autocomplete="off">
                        </div>
                        <div class="job-link-item">
                            <span class="job-number">4</span>
                            <input type="url" class="job-link-input" placeholder="https://linkdavaga4.com" id="jobLink4"
                                autocomplete="off">
                        </div>
                        <div class="job-link-item">
                            <span class="job-number">5</span>
                            <input type="url" class="job-link-input" placeholder="https://linkdavaga5.com" id="jobLink5"
                                autocomplete="off">
                        </div>
                        <div class="job-link-item">
                            <span class="job-number">6</span>
                            <input type="url" class="job-link-input" placeholder="https://linkdavaga6.com" id="jobLink6"
                                autocomplete="off">
                        </div>
                        <div class="job-link-item">
                            <span class="job-number">7</span>
                            <input type="url" class="job-link-input" placeholder="https://linkdavaga7.com" id="jobLink7"
                                autocomplete="off">
                        </div>
                    </div>

                    <div class="vagas-progress" id="vagasProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p class="progress-text" id="progressText">Preencha pelo menos 1 vaga para começar a análise</p>
                    </div>
                </div>
                </section>

                <div class="analyze-button-container">
                    <button class="analyze-button" id="analyzeBtn">Analise Agora Seu Currículo</button>
                </div>
            </div>

            <section class="features-section">
                <div class="container features-container">
                    <div class="feature-item">
                        <div class="feature-icon icon-ai"></div>
                        <div>
                            <h3 class="feature-title">Análise de Currículo com IA</h3>
                            <p class="feature-desc">Aproveite a inteligência artificial para identificar melhorias e
                                alinhar
                                seu perfil às exigências das vagas.</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon icon-feedback"></div>
                        <div>
                            <h3 class="feature-title">Feedback Personalizado</h3>
                            <p class="feature-desc">Descubra em segundos os pontos que podem destacar seu currículo no
                                mercado.</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon icon-optimization"></div>
                        <div>
                            <h3 class="feature-title">Otimização Para Cada Vaga</h3>
                            <p class="feature-desc">Adapte seu currículo às expectativas dos recrutadores e aumente suas
                                chances de sucesso.</p>
                        </div>
                    </div>
                </div>
            </section>
    </main>

    <footer>
        <div class="container footer-container">
            <div>
                <img src="assets/img/logo.png" alt="RH Super Sincero" class="footer-logo">
                <p class="copyright">© 2025 RH Super Sincero. Todos os direitos reservados.</p>
            </div>
            <div class="footer-links">
                <a href="privacy.html" class="footer-link">Políticas de Privacidade</a>
                <a href="terms.html" class="footer-link">Termos de Uso</a>
                <a href="contact.html" class="footer-link">Contato</a>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script>
        // Função para validar URL
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        // Função para atualizar progresso das vagas com micro-feedback
        window.updateVagasProgress = function () {
            const jobInputs = document.querySelectorAll('.job-link-input');
            const progressText = document.getElementById('vagasProgress');
            const creditsStatusBanner = document.getElementById('creditsStatusBanner');
            const creditsStatusDescription = document.getElementById('creditsStatusDescription');
            const currentCountElement = document.getElementById('currentCount');

            let filledCount = 0;
            jobInputs.forEach(input => {
                if (input.value.trim() !== '' && isValidUrl(input.value.trim())) {
                    filledCount++;
                    // Micro-feedback: borda verde para vagas válidas
                    input.style.borderColor = '#28a745';
                    input.style.borderWidth = '2px';
                } else if (input.value.trim() !== '') {
                    // URL inválida: borda vermelha
                    input.style.borderColor = '#dc3545';
                    input.style.borderWidth = '2px';
                } else {
                    // Vazio: borda padrão
                    input.style.borderColor = 'var(--border-color)';
                    input.style.borderWidth = '1px';
                }
            });

            // Atualizar contador visual
            if (currentCountElement) {
                currentCountElement.textContent = filledCount;
            }

            // Atualizar texto do progresso com emojis motivacionais
            if (filledCount === 7) {
                progressText.textContent = '🎉 Excelente! Todas as 7 vagas preenchidas - Análise completa garantida!';
                progressText.classList.add('completed');
                progressText.style.color = '#28a745';

                // Micro-feedback no banner quando tudo estiver preenchido
                if (creditsStatusDescription) {
                    const user = auth && auth.getUser ? auth.getUser() : null;
                    if (user && user.credits <= 0) {
                        creditsStatusDescription.textContent = '✨ Tudo preenchido! Agora você só precisa de créditos para analisar';
                    }
                }
            } else if (filledCount >= 1) {
                if (filledCount < 3) {
                    progressText.textContent = `✅ ${filledCount} vaga${filledCount > 1 ? 's' : ''} preenchida${filledCount > 1 ? 's' : ''} - Já pode analisar! Adicione mais para melhor resultado`;
                    progressText.style.color = '#2e7d32';
                } else if (filledCount < 7) {
                    progressText.textContent = `🚀 ${filledCount}/7 vagas preenchidas - Ótimo! Continue para maximizar a análise`;
                    progressText.style.color = '#ff9800';
                } else {
                    progressText.textContent = `⭐ ${filledCount}/7 vagas preenchidas - Excelente progresso!`;
                    progressText.style.color = '#ff9800';
                }
                progressText.classList.remove('completed');
            } else {
                progressText.textContent = '📝 Preencha pelo menos 1 vaga para começar a análise';
                progressText.classList.remove('completed');
                progressText.style.color = '#6c757d';
            }

            // Atualizar estado do botão de análise
            if (window.updateAnalyzeButton) {
                window.updateAnalyzeButton();
            }
        };

        // Função para atualizar estado do botão de análise
        window.updateAnalyzeButton = function () {
            // THROTTLING: Evitar chamadas muito rápidas consecutivas
            const now = Date.now();
            if (window.lastUpdateButtonCall && (now - window.lastUpdateButtonCall) < 300) {
                console.log('⏳ Throttling updateAnalyzeButton - muito rápido');
                return;
            }
            window.lastUpdateButtonCall = now;

            const analyzeBtn = document.getElementById('analyzeBtn');
            const fileInput = document.getElementById('fileInput');
            const creditsStatusBanner = document.getElementById('creditsStatusBanner');
            const creditsStatusText = document.getElementById('creditsStatusText');
            const creditsStatusDescription = document.getElementById('creditsStatusDescription');

            if (!analyzeBtn) return;

            const user = auth && auth.getUser ? auth.getUser() : null;

            // PROTEÇÃO: Se não há elementos do banner, não prosseguir
            if (!creditsStatusBanner) return;
            const fileSelected = fileInput && fileInput.files && fileInput.files.length > 0;
            const jobInputs = document.querySelectorAll('.job-link-input');

            // Contar vagas válidas preenchidas
            let validJobsCount = 0;
            jobInputs.forEach(input => {
                if (input.value.trim() !== '' && isValidUrl(input.value.trim())) {
                    validJobsCount++;
                }
            });

            const hasMinimumJobs = validJobsCount >= 1;
            const allRequirementsMet = fileSelected && hasMinimumJobs;

            // Controlar visibilidade e conteúdo do banner de créditos
            if (user) {
                // Verificação mais rigorosa para créditos
                const credits = typeof user.credits === 'number' ? user.credits : 0;

                console.log('🔍 Verificando créditos do usuário:', {
                    credits: credits,
                    rawCredits: user.credits,
                    type: typeof user.credits,
                    user: user
                });

                if (credits <= 0) {
                    // Mostrar banner para usuários sem créditos
                    console.log('⚠️ Usuário sem créditos, mostrando banner');
                    creditsStatusBanner.style.display = 'flex';
                    creditsStatusBanner.style.visibility = 'visible';
                    creditsStatusText.textContent = 'Você não tem análises disponíveis';
                    creditsStatusDescription.textContent = 'Você pode preencher tudo, mas precisará comprar créditos para analisar';
                } else {
                    // GARANTIR que banner nunca apareça quando há créditos
                    console.log('✅ Usuário com créditos, ocultando banner');
                    creditsStatusBanner.style.display = 'none';
                    creditsStatusBanner.style.visibility = 'hidden';
                }
            } else {
                // Usuário não logado - ocultar banner
                console.log('👤 Usuário não logado, ocultando banner');
                creditsStatusBanner.style.display = 'none';
                creditsStatusBanner.style.visibility = 'hidden';
            }

            // Estados do botão baseados nas condições
            if (!user) {
                // Usuário não logado
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = '🔐 Faça Login Para Continuar';
                analyzeBtn.style.opacity = '0.7';
                analyzeBtn.style.cursor = 'not-allowed';
                analyzeBtn.style.background = '#6c757d';

                // Limpar atributos de configuração quando não pode ser usado
                analyzeBtn.removeAttribute('data-analysis-ready');
                analyzeBtn.removeAttribute('data-payment-ready');
            } else if (!allRequirementsMet) {
                // Usuário logado mas requisitos não atendidos
                analyzeBtn.disabled = true;

                if (!fileSelected && !hasMinimumJobs) {
                    analyzeBtn.textContent = '📎 Anexe currículo e preencha pelo menos 1 vaga';
                } else if (!fileSelected) {
                    analyzeBtn.textContent = '📎 Anexe seu currículo para continuar';
                } else if (!hasMinimumJobs) {
                    analyzeBtn.textContent = '📝 Preencha pelo menos 1 vaga para analisar';
                }

                analyzeBtn.style.opacity = '0.7';
                analyzeBtn.style.cursor = 'not-allowed';
                analyzeBtn.style.background = '#6c757d';

                // Limpar atributos de configuração quando não pode ser usado
                analyzeBtn.removeAttribute('data-analysis-ready');
                analyzeBtn.removeAttribute('data-payment-ready');
            } else if ((typeof user.credits === 'number' ? user.credits : 0) <= 0) {
                // Usuário sem créditos mas requisitos atendidos
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = '💳 Comprar Análises Para Continuar';
                analyzeBtn.style.opacity = '1';
                analyzeBtn.style.cursor = 'pointer';
                analyzeBtn.style.background = '#FF9800';

                // Limpar atributo de análise quando o botão está em modo pagamento
                analyzeBtn.removeAttribute('data-analysis-ready');

                // Configurar evento de pagamento apenas se não foi configurado ainda
                if (!analyzeBtn.hasAttribute('data-payment-ready')) {
                    // Marcar como configurado para pagamento
                    analyzeBtn.setAttribute('data-payment-ready', 'true');

                    analyzeBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        // Mostrar modal de confirmação antes de redirecionar
                        if (confirm('Você preencheu tudo! 🎉\n\nPara analisar seu currículo, você precisa comprar créditos.\n\nDeseja ir para a página de pagamento agora?')) {
                            window.location.href = 'payment.html';
                        }
                    });
                }
            } else {
                // Tudo OK - pode analisar
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = '🚀 Analisar Currículo';
                analyzeBtn.style.opacity = '1';
                analyzeBtn.style.cursor = 'pointer';
                analyzeBtn.style.background = 'var(--primary-dark)';

                // Limpar atributo de pagamento quando o botão está em modo análise
                analyzeBtn.removeAttribute('data-payment-ready');

                // Configurar o evento de análise apenas se não foi configurado ainda
                if (!analyzeBtn.hasAttribute('data-analysis-ready')) {
                    // Marcar como configurado para evitar duplicação
                    analyzeBtn.setAttribute('data-analysis-ready', 'true');

                    // Adicionar event listener apenas uma vez
                    analyzeBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        console.log('🎯 Botão de análise clicado');

                        // Verificar se o botão está habilitado antes de prosseguir
                        if (analyzeBtn.disabled) {
                            console.log('⏸️ Botão desabilitado, ignorando clique');
                            return;
                        }

                        if (window.performAnalysis) {
                            console.log('▶️ Executando performAnalysis...');
                            window.performAnalysis();
                        } else {
                            console.error('❌ Função performAnalysis não encontrada');
                        }
                    });
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            // Funcionalidade para upload de arquivo
            const selectFileBtn = document.getElementById('selectFileBtn');
            const fileInput = document.getElementById('fileInput');
            const dropzone = document.getElementById('dropzone');
            const selectedFileDiv = document.getElementById('selectedFile');
            const fileNameSpan = selectedFileDiv.querySelector('.file-name');
            const removeFileBtn = selectedFileDiv.querySelector('.remove-file');

            // Inicialmente ocultar o componente
            selectedFileDiv.style.display = 'none';

            if (selectFileBtn && fileInput) {
                selectFileBtn.addEventListener('click', function (e) {
                    fileInput.click();
                });
            }

            // Drag and drop
            dropzone.addEventListener('dragover', function (e) {
                e.preventDefault();
                dropzone.classList.add('active');
            });

            dropzone.addEventListener('dragleave', function (e) {
                e.preventDefault();
                dropzone.classList.remove('active');
            });

            dropzone.addEventListener('drop', function (e) {
                e.preventDefault();
                dropzone.classList.remove('active');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    displaySelectedFile(files[0]);
                }
            });

            // Exibir nome do arquivo ao selecionar
            fileInput.addEventListener('change', function (e) {
                if (fileInput.files && fileInput.files.length > 0) {
                    displaySelectedFile(fileInput.files[0]);
                } else {
                    selectedFileDiv.style.display = 'none';
                }
                // Atualizar estado do botão quando arquivo é selecionado/removido
                if (window.updateAnalyzeButton) {
                    window.updateAnalyzeButton();
                }
            });

            function displaySelectedFile(file) {
                fileNameSpan.textContent = file.name;
                selectedFileDiv.style.display = 'flex';
                removeFileBtn.style.display = 'inline-block';
            }

            // Remover arquivo
            removeFileBtn.addEventListener('click', function () {
                fileInput.value = '';
                selectedFileDiv.style.display = 'none';
                if (window.updateAnalyzeButton) {
                    window.updateAnalyzeButton();
                }
            });

            // Ocultar botão de adicionar vaga (não é mais necessário com 7 vagas fixas)
            const addJobLinkBtn = document.getElementById('addJobLinkBtn');
            if (addJobLinkBtn) {
                addJobLinkBtn.style.display = 'none';
            }

            // Atualizar créditos na interface do header se necessário
            const user = auth.getUser();
            if (user && window.updateHeaderCredits) {
                window.updateHeaderCredits();
            }

            // Forçar atualização dos créditos do servidor quando a página carrega
            if (user && typeof window.auth.fetchUserCredits === 'function') {
                console.log('🔄 Forçando atualização de créditos do servidor...');
                window.auth.fetchUserCredits(true).then(() => {
                    console.log('✅ Créditos atualizados do servidor');
                    // Atualizar botão após buscar créditos
                    if (window.updateAnalyzeButton) {
                        setTimeout(window.updateAnalyzeButton, 100);
                    }
                }).catch(err => {
                    console.log('⚠️ Erro ao atualizar créditos:', err);
                });
            }

            // Adicionar listeners para todos os inputs de vagas
            document.querySelectorAll('.job-link-input').forEach(input => {
                input.addEventListener('input', window.updateVagasProgress);
                input.addEventListener('blur', window.updateVagasProgress);
                input.addEventListener('paste', () => {
                    setTimeout(window.updateVagasProgress, 100);
                });
            });

            // Inicializar progresso das vagas
            if (window.updateVagasProgress) {
                window.updateVagasProgress();
            }

            // Atualizar estado inicial do botão (com delay para evitar conflitos)
            if (window.updateAnalyzeButton) {
                setTimeout(window.updateAnalyzeButton, 200);
            }

            // Listener para eventos de atualização de créditos
            window.addEventListener('userCreditsUpdated', function (event) {
                console.log('💳 Evento de créditos atualizado detectado:', event.detail);
                if (window.updateAnalyzeButton) {
                    setTimeout(window.updateAnalyzeButton, 50);
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const showRegisterLink = document.getElementById('showRegister');
            const showLoginLink = document.getElementById('showLogin');
            const authError = document.getElementById('authError');

            // 🔧 CORREÇÃO: Função para decidir para onde redirecionar ao fechar modal
            function handleModalClose() {
                const urlParams = new URLSearchParams(window.location.search);
                const loginParam = urlParams.get('login');
                const giftCodeParam = urlParams.get('giftCode');

                // 🎨 UX: Sempre remover blur antes de qualquer ação
                const mainContent = document.querySelector('.main-content');
                const header = document.querySelector('header');
                if (mainContent) mainContent.style.filter = '';
                if (header) header.style.filter = '';

                // Se veio de login=true, voltar para landing
                // Se veio com giftCode, voltar para landing
                // Caso contrário, comportamento padrão
                if (loginParam === 'true' || giftCodeParam) {
                    window.location.href = 'landing.html';
                } else {
                    // Se não veio de redirecionamento específico, apenas fechar o modal
                    document.getElementById('authModal').style.display = 'none';
                    document.body.style.overflow = '';
                }
            }

            // Event listener para o botão de fechar do modal de login
            document.getElementById('closeAuthModal').addEventListener('click', function () {
                handleModalClose();
            });

            // Event listener para fechar modal clicando no fundo
            document.getElementById('authModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    handleModalClose();
                }
            });

            // Event listener global para tecla ESC fechar modais
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    // Fechar modal de login se estiver aberto
                    const authModal = document.getElementById('authModal');
                    if (authModal && authModal.style.display === 'flex') {
                        handleModalClose();
                        return;
                    }

                    // Fechar modal de erro do código de presente se estiver aberto
                    const errorModal = document.getElementById('giftCodeErrorModal');
                    if (errorModal) {
                        window.location.href = 'landing.html';
                        return;
                    }

                    // Fechar modal de boas-vindas do código de presente se estiver aberto
                    const welcomeModal = document.getElementById('giftCodeWelcomeModal');
                    if (welcomeModal) {
                        window.location.href = 'landing.html';
                        return;
                    }
                }
            });

            // Função para alternar para o formulário de cadastro
            window.switchToRegister = function () {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                document.getElementById('authModalTitle').textContent = 'Cadastrar';
                authError.style.display = 'none';
                // Preencher o email se foi digitado no formulário de login
                const loginEmail = document.getElementById('loginEmail').value;
                if (loginEmail) {
                    document.getElementById('registerEmail').value = loginEmail;
                }
            };

            showRegisterLink.addEventListener('click', function (e) {
                e.preventDefault();
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                document.getElementById('authModalTitle').textContent = 'Cadastrar';
                authError.style.display = 'none';
            });

            showLoginLink.addEventListener('click', function (e) {
                e.preventDefault();
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                document.getElementById('authModalTitle').textContent = 'Entrar';
                authError.style.display = 'none';
            });

            loginForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                auth.loginUser(email, password)
                    .then(function () {
                        // Verificar se realmente há um código pendente válido da URL atual
                        const urlParams = new URLSearchParams(window.location.search);
                        const giftCodeFromUrl = urlParams.get('giftCode');
                        const pendingCode = localStorage.getItem('giftCode') || localStorage.getItem('pendingGiftCode');

                        // Flag para rastrear se há código de presente
                        let hasGiftCode = false;

                        // Só aplicar código se:
                        // 1. Há um código na URL atual OU
                        // 2. Há um código pendente e o usuário veio de uma página com código
                        if (giftCodeFromUrl && giftCodeFromUrl.trim() !== '') {
                            // Aplicar código que veio da URL
                            hasGiftCode = true;
                            applyGiftCodeAfterAuth(giftCodeFromUrl);
                        } else if (pendingCode && pendingCode.trim() !== '' && document.referrer.includes('giftCode=')) {
                            // Só aplicar código pendente se o usuário veio de uma página com código
                            hasGiftCode = true;
                            applyGiftCodeAfterAuth(pendingCode);
                        } else {
                            // Limpar códigos antigos se não há código válido
                            localStorage.removeItem('giftCode');
                            localStorage.removeItem('pendingGiftCode');
                        }

                        // 🔧 CORREÇÃO CRÍTICA: Garantir que authSuccess seja SEMPRE chamada
                        if (hasGiftCode) {
                            // Se há código, aguardar um tempo mas SEMPRE chamar authSuccess
                            setTimeout(() => {
                                window.authSuccess();
                            }, 2500); // 2.5 segundos de timeout

                            // 🚨 CORREÇÃO ULTRA-ROBUSTA: Backup garantido após 5 segundos
                            setTimeout(() => {
                                console.log('🚨 TIMEOUT BACKUP: Forçando authSuccess após 5 segundos');
                                if (document.getElementById('authModal') && document.getElementById('authModal').style.display !== 'none') {
                                    console.log('🔧 Modal ainda aberto, forçando fechamento');
                                    window.authSuccess();
                                }
                            }, 5000); // 5 segundos como último recurso
                        } else {
                            // Se não há código, chamar imediatamente
                            window.authSuccess();
                        }
                    })
                    .catch(function (error) {
                        // Verificar se é erro de usuário não encontrado/precisa se cadastrar
                        if (error.message && error.message.includes('ainda não está cadastrado')) {
                            // Mostrar mensagem específica e alternar para tela de cadastro
                            authError.innerHTML = `
                                <div style="margin-bottom: 15px;">
                                    <strong>Este email ainda não está cadastrado!</strong><br>
                                    <span style="font-size: 14px;">Clique no botão abaixo para criar sua conta primeiro.</span>
                                </div>
                                <button onclick="switchToRegister()" style="background: #2a7a2a; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    ✨ Criar Minha Conta Agora
                                </button>
                            `;
                            authError.style.display = 'block';
                            authError.style.color = '#2a7a2a';
                            authError.style.background = '#f0f9f0';
                            authError.style.padding = '15px';
                            authError.style.borderRadius = '8px';
                            authError.style.border = '1px solid #2a7a2a';
                        } else {
                            // Outros tipos de erro (senha incorreta, etc.)
                            authError.textContent = error.message || 'Erro ao fazer login';
                            authError.style.display = 'block';
                            authError.style.color = '#b22';
                            authError.style.background = 'transparent';
                            authError.style.padding = '0';
                            authError.style.borderRadius = '0';
                            authError.style.border = 'none';
                        }
                    });
            });

            registerForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                auth.registerUser(name, email, password)
                    .then(function () {
                        // Após cadastro bem-sucedido, fazer login automaticamente
                        return auth.loginUser(email, password);
                    })
                    .then(function () {
                        // Verificar se realmente há um código pendente válido da URL atual
                        const urlParams = new URLSearchParams(window.location.search);
                        const giftCodeFromUrl = urlParams.get('giftCode');
                        const pendingCode = localStorage.getItem('giftCode') || localStorage.getItem('pendingGiftCode');

                        // Flag para rastrear se há código de presente
                        let hasGiftCode = false;

                        // Só aplicar código se:
                        // 1. Há um código na URL atual OU
                        // 2. Há um código pendente e o usuário veio de uma página com código
                        if (giftCodeFromUrl && giftCodeFromUrl.trim() !== '') {
                            // Aplicar código que veio da URL
                            hasGiftCode = true;
                            applyGiftCodeAfterAuth(giftCodeFromUrl);
                        } else if (pendingCode && pendingCode.trim() !== '' && document.referrer.includes('giftCode=')) {
                            // Só aplicar código pendente se o usuário veio de uma página com código
                            hasGiftCode = true;
                            applyGiftCodeAfterAuth(pendingCode);
                        } else {
                            // Limpar códigos antigos se não há código válido
                            localStorage.removeItem('giftCode');
                            localStorage.removeItem('pendingGiftCode');
                        }

                        // 🔧 CORREÇÃO CRÍTICA: Garantir que authSuccess seja SEMPRE chamada
                        if (hasGiftCode) {
                            // Se há código, aguardar um tempo mas SEMPRE chamar authSuccess
                            setTimeout(() => {
                                window.authSuccess();
                            }, 2500); // 2.5 segundos de timeout

                            // 🚨 CORREÇÃO ULTRA-ROBUSTA: Backup garantido após 5 segundos
                            setTimeout(() => {
                                console.log('🚨 TIMEOUT BACKUP: Forçando authSuccess após 5 segundos');
                                if (document.getElementById('authModal') && document.getElementById('authModal').style.display !== 'none') {
                                    console.log('🔧 Modal ainda aberto, forçando fechamento');
                                    window.authSuccess();
                                }
                            }, 5000); // 5 segundos como último recurso
                        } else {
                            // Se não há código, chamar imediatamente
                            window.authSuccess();
                        }
                    })
                    .catch(function (error) {
                        // Se falhou no cadastro, mostrar erro de cadastro
                        // Se falhou no login automático, mostrar formulário de login
                        if (error.message && error.message.includes('já existe')) {
                            authError.textContent = error.message;
                            authError.style.color = '#b22';
                            authError.style.display = 'block';
                        } else {
                            registerForm.reset();
                            loginForm.style.display = 'block';
                            registerForm.style.display = 'none';
                            document.getElementById('authModalTitle').textContent = 'Entrar';
                            authError.textContent = 'Cadastro realizado! Faça login para continuar.';
                            authError.style.color = '#2a7a2a';
                            authError.style.display = 'block';
                        }
                    });
            });

            // Verificar parâmetros da URL
            const urlParams = new URLSearchParams(window.location.search);
            const giftCodeFromUrl = urlParams.get('giftCode');
            const loginParam = urlParams.get('login'); // Verificar parâmetro login=true

            if (giftCodeFromUrl && giftCodeFromUrl.trim() !== '') {
                // Se há código na URL, validar primeiro ANTES de pedir login
                console.log('🎁 Código detectado na URL:', giftCodeFromUrl);
                validateGiftCodeBeforeAuth(giftCodeFromUrl.trim());
                return; // Não mostrar modal de login ainda
            }

            // Verificar se usuário está autenticado
            if (!auth.getToken()) {
                // 🔧 CORREÇÃO: Verificar se foi redirecionado para fazer login (login=true)
                if (loginParam === 'true') {
                    console.log('🔐 Redirecionamento para login detectado - mostrando modal');
                    // Mostrar modal de login imediatamente sem bloquear o conteúdo
                    document.getElementById('authModal').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    // Garantir que o formulário de login esteja visível
                    document.getElementById('loginForm').style.display = 'block';
                    document.getElementById('registerForm').style.display = 'none';
                    document.getElementById('authModalTitle').textContent = 'Entrar';
                    // NÃO esconder o conteúdo principal quando vem de login=true
                    return;
                }

                // Casos normais: exibir modal e bloquear tudo se não autenticado E não há código
                document.getElementById('authModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                const mainContent = document.querySelector('.main-content');
                if (mainContent) mainContent.style.display = 'none';
                const footer = document.querySelector('footer');
                if (footer) footer.style.display = 'none';
                const logoContainer = document.querySelector('.logo-container');
                if (logoContainer) logoContainer.style.opacity = 0.3;
            } else {
                window.authSuccess();
            }
        });
    </script>

    <!-- Função global performAnalysis -->
    <script>
        window.performAnalysis = function () {
            console.log('🚀 performAnalysis() chamada');

            // Verificar autenticação
            if (!window.auth || !window.auth.getToken()) {
                console.log('❌ Usuário não autenticado');
                // Mostrar modal de autenticação
                const authModal = document.getElementById('authModal');
                if (authModal) {
                    authModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
                return;
            }

            // Obter arquivo selecionado
            const fileInput = document.getElementById('fileInput');
            const selectedFile = fileInput ? fileInput.files[0] : null;

            // Coletar links das vagas
            let jobLinks = [];
            document.querySelectorAll('.job-link-input').forEach(input => {
                if (input.value.trim()) {
                    jobLinks.push(input.value.trim());
                }
            });

            console.log('📁 Arquivo selecionado:', selectedFile?.name);
            console.log('🔗 Links das vagas:', jobLinks);

            // Validação
            if (!selectedFile) {
                alert('Selecione um currículo para análise.');
                return;
            }

            if (jobLinks.length === 0) {
                alert('Informe pelo menos um link de vaga para análise.');
                return;
            }

            // Processar o arquivo selecionado
            console.log('📊 Iniciando processamento...');

            const reader = new FileReader();
            reader.onload = function (e) {
                const fileContentBase64 = e.target.result;
                try {
                    // Salvar dados na sessionStorage
                    sessionStorage.setItem('atsFile', selectedFile.name);
                    sessionStorage.setItem('atsFileContent', fileContentBase64);
                    sessionStorage.setItem('atsJobLinks', JSON.stringify(jobLinks));

                    console.log('✅ Dados salvos, redirecionando...');

                    // Redirecionar para página de loading
                    window.location.href = 'loading.html';
                } catch (err) {
                    console.error('❌ Erro ao salvar dados:', err);
                    alert('Erro ao salvar dados para análise. Tente novamente.');
                }
            };

            reader.onerror = function () {
                console.error('❌ Erro ao ler o arquivo');
                alert('Erro ao ler o arquivo. Tente outro formato.');
            };

            // Iniciar a leitura do arquivo
            reader.readAsDataURL(selectedFile);
        };

        console.log('✅ Função performAnalysis definida globalmente');
    </script>
</body>

</html>