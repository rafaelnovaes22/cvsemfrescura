<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Dashboard de Custos - CV Sem Frescura</title>
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .costs-dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #FFFCF9;
            min-height: 100vh;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #583819, #6B4423);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(88, 56, 25, 0.2);
        }

        .dashboard-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
        }

        .dashboard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #583819;
            transition: transform 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .metric-card.warning {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #fff, #fef9e7);
        }

        .metric-card.critical {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fff, #fdf2f2);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .metric-title {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            font-size: 1.5rem;
        }

        .metric-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #583819;
            margin-bottom: 8px;
        }

        .metric-subtitle {
            font-size: 0.9rem;
            color: #888;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #583819;
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: #f39c12;
        }

        .progress-fill.critical {
            background: #e74c3c;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #583819;
            margin-bottom: 20px;
            text-align: center;
        }

        .api-breakdown {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .api-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .api-item:last-child {
            border-bottom: none;
        }

        .api-name {
            font-weight: 600;
            color: #583819;
        }

        .api-cost {
            font-weight: bold;
            color: #2c3e50;
        }

        .api-usage {
            font-size: 0.9rem;
            color: #666;
        }

        .alerts-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .alert-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .alert-item.warning {
            background: #fef9e7;
            border-left-color: #f39c12;
        }

        .alert-item.critical {
            background: #fdf2f2;
            border-left-color: #e74c3c;
        }

        .alert-item.info {
            background: #e8f4fd;
            border-left-color: #3498db;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #583819;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(88, 56, 25, 0.3);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #6B4423;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(88, 56, 25, 0.4);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #583819;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="costs-dashboard">
        <div class="dashboard-header">
            <h1>üí∞ Dashboard de Custos das APIs</h1>
            <p>Monitoramento em tempo real dos gastos com servi√ßos externos</p>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Carregando dados de custos...</p>
        </div>

        <div id="dashboard-content" style="display: none;">
            <!-- M√©tricas Principais -->
            <div class="metrics-grid">
                <div class="metric-card" id="daily-cost-card">
                    <div class="metric-header">
                        <span class="metric-title">Custo Hoje</span>
                        <span class="metric-icon">üìÖ</span>
                    </div>
                    <div class="metric-value" id="daily-cost">$0.00</div>
                    <div class="metric-subtitle" id="daily-subtitle">de $10.00 limite di√°rio</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="daily-progress"></div>
                    </div>
                </div>

                <div class="metric-card" id="monthly-cost-card">
                    <div class="metric-header">
                        <span class="metric-title">Custo Mensal</span>
                        <span class="metric-icon">üìä</span>
                    </div>
                    <div class="metric-value" id="monthly-cost">$0.00</div>
                    <div class="metric-subtitle" id="monthly-subtitle">de $200.00 limite mensal</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="monthly-progress"></div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Proje√ß√£o Mensal</span>
                        <span class="metric-icon">üìà</span>
                    </div>
                    <div class="metric-value" id="projected-cost">$0.00</div>
                    <div class="metric-subtitle" id="projection-subtitle">baseado no uso atual</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-title">Dias Restantes</span>
                        <span class="metric-icon">‚è∞</span>
                    </div>
                    <div class="metric-value" id="days-remaining">--</div>
                    <div class="metric-subtitle" id="depletion-subtitle">at√© esgotar or√ßamento</div>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="charts-section">
                <div class="chart-container">
                    <h3 class="chart-title">Distribui√ß√£o de Custos por API</h3>
                    <canvas id="apiCostsChart" width="400" height="300"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Tend√™ncia de Gastos (7 dias)</h3>
                    <canvas id="trendChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Breakdown por API -->
            <div class="api-breakdown">
                <h3 class="chart-title">Detalhamento por Servi√ßo</h3>
                <div id="api-breakdown-list">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>

            <!-- Alertas -->
            <div class="alerts-section">
                <h3 class="chart-title">üö® Alertas e Notifica√ß√µes</h3>
                <div id="alerts-list">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
        </div>

        <button class="refresh-btn" onclick="loadDashboard()">
            üîÑ Atualizar
        </button>
    </div>

    <script>
        let apiCostsChart = null;
        let trendChart = null;

        // Carregar dashboard
        async function loadDashboard() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dashboard-content').style.display = 'none';

                const response = await fetch('/api/monitoring/costs');
                const data = await response.json();

                if (data.status === 'success') {
                    updateMetrics(data.costs, data.estimation);
                    updateCharts(data.costs);
                    updateApiBreakdown(data.costs);
                    updateAlerts(data.costs, data.estimation);
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';

            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #e74c3c;">
                        <h3>‚ùå Erro ao carregar dados</h3>
                        <p>${error.message}</p>
                        <button onclick="loadDashboard()" style="margin-top: 20px; padding: 10px 20px; background: #583819; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Atualizar m√©tricas principais
        function updateMetrics(costs, estimation) {
            // Custo di√°rio
            const dailyCost = costs.today.total;
            const dailyLimit = costs.today.limit;
            const dailyPercentage = costs.today.percentage;

            document.getElementById('daily-cost').textContent = `$${dailyCost.toFixed(2)}`;
            document.getElementById('daily-subtitle').textContent = `de $${dailyLimit.toFixed(2)} limite di√°rio`;

            const dailyProgress = document.getElementById('daily-progress');
            dailyProgress.style.width = `${Math.min(dailyPercentage, 100)}%`;

            const dailyCard = document.getElementById('daily-cost-card');
            if (dailyPercentage >= 100) {
                dailyCard.className = 'metric-card critical';
                dailyProgress.className = 'progress-fill critical';
            } else if (dailyPercentage >= 80) {
                dailyCard.className = 'metric-card warning';
                dailyProgress.className = 'progress-fill warning';
            } else {
                dailyCard.className = 'metric-card';
                dailyProgress.className = 'progress-fill';
            }

            // Custo mensal
            const monthlyCost = costs.thisMonth.total;
            const monthlyLimit = costs.thisMonth.limit;
            const monthlyPercentage = costs.thisMonth.percentage;

            document.getElementById('monthly-cost').textContent = `$${monthlyCost.toFixed(2)}`;
            document.getElementById('monthly-subtitle').textContent = `de $${monthlyLimit.toFixed(2)} limite mensal`;

            const monthlyProgress = document.getElementById('monthly-progress');
            monthlyProgress.style.width = `${Math.min(monthlyPercentage, 100)}%`;

            const monthlyCard = document.getElementById('monthly-cost-card');
            if (monthlyPercentage >= 100) {
                monthlyCard.className = 'metric-card critical';
                monthlyProgress.className = 'progress-fill critical';
            } else if (monthlyPercentage >= 80) {
                monthlyCard.className = 'metric-card warning';
                monthlyProgress.className = 'progress-fill warning';
            } else {
                monthlyCard.className = 'metric-card';
                monthlyProgress.className = 'progress-fill';
            }

            // Proje√ß√£o
            document.getElementById('projected-cost').textContent = `$${costs.thisMonth.projected.toFixed(2)}`;

            const isOnTrack = costs.insights.isOnTrack;
            document.getElementById('projection-subtitle').textContent = isOnTrack
                ? 'dentro do or√ßamento'
                : 'acima do or√ßamento';

            // Dias restantes
            if (estimation.status === 'normal') {
                document.getElementById('days-remaining').textContent = estimation.daysUntilDepletion;
                document.getElementById('depletion-subtitle').textContent = `at√© ${new Date(estimation.depletionDate).toLocaleDateString('pt-BR')}`;
            } else if (estimation.status === 'exceeded') {
                document.getElementById('days-remaining').textContent = '0';
                document.getElementById('depletion-subtitle').textContent = 'or√ßamento excedido';
            } else {
                document.getElementById('days-remaining').textContent = '--';
                document.getElementById('depletion-subtitle').textContent = 'sem dados suficientes';
            }
        }

        // Atualizar gr√°ficos
        function updateCharts(costs) {
            // Gr√°fico de distribui√ß√£o por API
            const apiData = costs.thisMonth.breakdown;
            const apiLabels = Object.keys(apiData);
            const apiValues = Object.values(apiData).map(api => api.total);

            if (apiCostsChart) {
                apiCostsChart.destroy();
            }

            const ctx1 = document.getElementById('apiCostsChart').getContext('2d');
            apiCostsChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: apiLabels.map(label => label.toUpperCase()),
                    datasets: [{
                        data: apiValues,
                        backgroundColor: [
                            '#583819',
                            '#6B4423',
                            '#8B5A2B',
                            '#A0522D',
                            '#CD853F'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gr√°fico de tend√™ncia (simulado - em produ√ß√£o, usar dados hist√≥ricos)
            const trendLabels = ['6 dias', '5 dias', '4 dias', '3 dias', '2 dias', 'Ontem', 'Hoje'];
            const trendData = [
                costs.thisMonth.avgDaily * 0.8,
                costs.thisMonth.avgDaily * 0.9,
                costs.thisMonth.avgDaily * 1.1,
                costs.thisMonth.avgDaily * 0.7,
                costs.thisMonth.avgDaily * 1.2,
                costs.thisMonth.avgDaily * 0.95,
                costs.today.total
            ];

            if (trendChart) {
                trendChart.destroy();
            }

            const ctx2 = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Custo Di√°rio ($)',
                        data: trendData,
                        borderColor: '#583819',
                        backgroundColor: 'rgba(88, 56, 25, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Atualizar breakdown por API
        function updateApiBreakdown(costs) {
            const breakdown = costs.thisMonth.breakdown;
            const container = document.getElementById('api-breakdown-list');

            if (Object.keys(breakdown).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum uso detectado ainda</p>';
                return;
            }

            container.innerHTML = Object.entries(breakdown).map(([api, data]) => {
                const services = Object.entries(data.services).map(([service, serviceData]) =>
                    `<div class="api-usage">${service}: ${serviceData.count} chamadas</div>`
                ).join('');

                return `
                    <div class="api-item">
                        <div>
                            <div class="api-name">${api.toUpperCase()}</div>
                            ${services}
                        </div>
                        <div class="api-cost">$${data.total.toFixed(4)}</div>
                    </div>
                `;
            }).join('');
        }

        // Atualizar alertas
        function updateAlerts(costs, estimation) {
            const alerts = [];

            // Verificar limites
            if (costs.today.percentage >= 100) {
                alerts.push({
                    type: 'critical',
                    message: 'üö® Limite di√°rio excedido! Considere pausar opera√ß√µes n√£o essenciais.'
                });
            } else if (costs.today.percentage >= 80) {
                alerts.push({
                    type: 'warning',
                    message: '‚ö†Ô∏è Limite di√°rio pr√≥ximo (80%). Monitore o uso com aten√ß√£o.'
                });
            }

            if (costs.thisMonth.percentage >= 100) {
                alerts.push({
                    type: 'critical',
                    message: 'üö® Limite mensal excedido! A√ß√£o imediata necess√°ria.'
                });
            } else if (costs.thisMonth.percentage >= 80) {
                alerts.push({
                    type: 'warning',
                    message: '‚ö†Ô∏è Limite mensal pr√≥ximo (80%). Planeje o uso para o resto do m√™s.'
                });
            }

            // Verificar proje√ß√£o
            if (!costs.insights.isOnTrack) {
                alerts.push({
                    type: 'warning',
                    message: 'üìà Proje√ß√£o mensal acima do or√ßamento. Considere otimizar o uso das APIs.'
                });
            }

            // Verificar burn rate
            if (costs.insights.burnRate === 'high') {
                alerts.push({
                    type: 'info',
                    message: 'üî• Taxa de consumo alta. Monitore para evitar surpresas.'
                });
            }

            // Verificar estimativa de deple√ß√£o
            if (estimation.status === 'exceeded') {
                alerts.push({
                    type: 'critical',
                    message: 'üí∏ Or√ßamento j√° excedido! Adicione cr√©ditos ou reduza o uso.'
                });
            } else if (estimation.daysUntilDepletion <= 7) {
                alerts.push({
                    type: 'warning',
                    message: `‚è∞ Cr√©ditos estimados para durar apenas ${estimation.daysUntilDepletion} dias.`
                });
            }

            const container = document.getElementById('alerts-list');

            if (alerts.length === 0) {
                container.innerHTML = '<div class="alert-item info">‚úÖ Tudo funcionando normalmente. Nenhum alerta ativo.</div>';
            } else {
                container.innerHTML = alerts.map(alert =>
                    `<div class="alert-item ${alert.type}">${alert.message}</div>`
                ).join('');
            }
        }

        // Auto-refresh a cada 5 minutos
        setInterval(loadDashboard, 5 * 60 * 1000);

        // Carregar dashboard ao inicializar
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>

</html>