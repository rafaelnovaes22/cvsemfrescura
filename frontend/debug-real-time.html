<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Tempo Real - Gift Code</title>
    <style>
        body {
            font-family: monospace;
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            margin: 0;
        }

        .log {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            height: 70vh;
            overflow-y: auto;
            border: 1px solid #333;
            font-size: 14px;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #005c99;
        }

        button.red {
            background: #dc3545;
        }

        button.green {
            background: #28a745;
        }

        input {
            padding: 10px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #333;
            color: white;
            font-size: 14px;
        }

        .status {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #007acc;
        }

        .error {
            border-left-color: #dc3545;
        }

        .success {
            border-left-color: #28a745;
        }

        .warning {
            border-left-color: #ffc107;
        }
    </style>
</head>

<body>
    <h1>üîç Debug em Tempo Real - Gift Code</h1>

    <div class="status" id="status">
        <strong>Status:</strong> Aguardando testes...
    </div>

    <div class="controls">
        <input type="text" id="testCode" placeholder="C√≥digo (ex: TESTE123)" value="TESTE123">
        <input type="email" id="testEmail" placeholder="Email" value="teste@exemplo.com">
        <input type="password" id="testPassword" placeholder="Senha" value="123456">
        <button onclick="testFullFlow()" class="green">üß™ Teste Completo</button>
        <button onclick="testValidateOnly()" class="blue">‚úÖ S√≥ Validar</button>
        <button onclick="testLoginOnly()" class="blue">üîê S√≥ Login</button>
        <button onclick="clearLog()" class="red">üóëÔ∏è Limpar</button>
    </div>

    <div class="log" id="log"></div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.host;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const colors = {
                info: '#00ff00',
                error: '#ff4444',
                warning: '#ffaa00',
                success: '#44ff44'
            };

            const color = colors[type] || '#ffffff';
            logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = `<strong>Status:</strong> ${message}`;
            statusElement.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Simular exatamente o que acontece em analisar.html
        function simulateAuthSuccess() {
            log('üéâ Simulando authSuccess()', 'success');

            // Simular o que deveria acontecer ap√≥s login bem-sucedido
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.display = '';
                log('‚úÖ main-content mostrado', 'success');
            } else {
                log('‚ùå main-content n√£o encontrado', 'error');
            }

            const authModal = document.getElementById('authModal');
            if (authModal) {
                authModal.style.display = 'none';
                log('‚úÖ authModal fechado', 'success');
            } else {
                log('‚ùå authModal n√£o encontrado', 'error');
            }

            document.body.style.overflow = '';
            log('‚úÖ Scroll restaurado', 'success');
        }

        async function testValidateOnly() {
            const code = document.getElementById('testCode').value;
            log(`üîç TESTE: Valida√ß√£o de c√≥digo "${code}"`, 'info');
            updateStatus('Testando valida√ß√£o...', 'warning');

            try {
                const response = await fetch(`${API_BASE}/api/gift-code/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                log(`üì• Status: ${response.status}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                log(`üìÑ Resposta: ${JSON.stringify(data, null, 2)}`, 'info');

                if (data.valid) {
                    updateStatus('‚úÖ C√≥digo v√°lido!', 'success');
                } else {
                    updateStatus('‚ùå C√≥digo inv√°lido', 'error');
                }

            } catch (error) {
                log(`‚ùå Erro na valida√ß√£o: ${error.message}`, 'error');
                updateStatus('‚ùå Erro de conex√£o', 'error');
            }
        }

        async function testLoginOnly() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            log(`üîê TESTE: Login "${email}"`, 'info');
            updateStatus('Testando login...', 'warning');

            try {
                const response = await fetch(`${API_BASE}/api/user/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                log(`üì• Status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Login bem-sucedido! Token: ${data.token?.substring(0, 20)}...`, 'success');
                    updateStatus('‚úÖ Login realizado', 'success');

                    // Salvar token para pr√≥ximos testes
                    localStorage.setItem('debugToken', data.token);
                    return data.token;
                } else {
                    const error = await response.json();
                    log(`‚ùå Erro no login: ${error.error || 'Desconhecido'}`, 'error');
                    updateStatus('‚ùå Falha no login', 'error');
                }

            } catch (error) {
                log(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
                updateStatus('‚ùå Erro de conex√£o', 'error');
            }
        }

        async function testApplyGiftCode(code, token) {
            log(`üéÅ TESTE: Aplica√ß√£o de c√≥digo "${code}"`, 'info');

            try {
                const response = await fetch(`${API_BASE}/api/gift-code/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ code })
                });

                log(`üì• Status aplica√ß√£o: ${response.status}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                log(`üìÑ Resposta aplica√ß√£o: ${JSON.stringify(data, null, 2)}`, 'info');

                if (data.success) {
                    log(`‚úÖ C√≥digo aplicado! Cr√©ditos: ${data.credits}`, 'success');
                    return true;
                } else {
                    log(`‚ùå Falha na aplica√ß√£o: ${data.error}`, 'error');
                    return false;
                }

            } catch (error) {
                log(`‚ùå Erro na aplica√ß√£o: ${error.message}`, 'error');
                return false;
            }
        }

        async function testFullFlow() {
            const code = document.getElementById('testCode').value;
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            log('üöÄ INICIANDO TESTE COMPLETO DO FLUXO', 'warning');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
            updateStatus('Executando teste completo...', 'warning');

            // Passo 1: Validar c√≥digo
            log('üìç PASSO 1: Valida√ß√£o do c√≥digo', 'info');
            await testValidateOnly();
            await sleep(500);

            // Passo 2: Login
            log('üìç PASSO 2: Login do usu√°rio', 'info');
            const token = await testLoginOnly();
            if (!token) {
                log('‚ùå TESTE ABORTADO: Login falhou', 'error');
                updateStatus('‚ùå Teste falhou no login', 'error');
                return;
            }
            await sleep(500);

            // Passo 3: Aplicar c√≥digo
            log('üìç PASSO 3: Aplica√ß√£o do c√≥digo', 'info');
            const applied = await testApplyGiftCode(code, token);
            await sleep(500);

            // Passo 4: Simular authSuccess
            log('üìç PASSO 4: Simula√ß√£o de authSuccess', 'info');
            simulateAuthSuccess();

            // SIMULA√á√ÉO DO PROBLEMA REAL
            log('üîç SIMULANDO CEN√ÅRIO DE PRODU√á√ÉO...', 'warning');

            // Simular timeout de 2.5 segundos (nossa corre√ß√£o)
            log('‚è±Ô∏è Aguardando timeout de 2.5 segundos...', 'warning');
            setTimeout(() => {
                log('‚è∞ TIMEOUT ATINGIDO!', 'warning');
                log('üéâ Chamando authSuccess() via timeout...', 'success');
                simulateAuthSuccess();

                if (applied) {
                    updateStatus('‚úÖ Teste completo SUCESSO!', 'success');
                    log('‚úÖ RESULTADO: Fluxo funcionaria corretamente', 'success');
                } else {
                    updateStatus('‚ö†Ô∏è Teste OK mas c√≥digo falhou', 'warning');
                    log('‚ö†Ô∏è RESULTADO: Login funcionaria, c√≥digo falharia', 'warning');
                }
            }, 2500);

            updateStatus('‚è±Ô∏è Aguardando timeout...', 'warning');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Inicializa√ß√£o
        log('üîç Debug em tempo real carregado', 'success');
        log(`üåê API Base: ${API_BASE}`, 'info');
        log('üí° Use os bot√µes acima para testar cada parte do fluxo', 'info');
        log('', 'info');
    </script>
</body>

</html>