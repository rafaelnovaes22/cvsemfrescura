<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Stripe Din√¢mico - CV Sem Frescura</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #payment-element {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 200px;
        }

        button {
            background-color: #583819;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            background-color: #432b13;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .logs {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Teste Stripe Din√¢mico - CV Sem Frescura</h1>
        <p><strong>Este teste usa chaves carregadas dinamicamente do backend (.env)</strong></p>

        <div class="test-section">
            <h2>üìã Status da Conex√£o</h2>
            <div id="connection-status" class="status info">üîÑ Verificando conex√£o...</div>

            <h2>üîë Teste de Chaves</h2>
            <button onclick="testStripeKeyLoading()">üîÑ Testar Carregamento da Chave</button>
            <div id="key-status" class="status info">Clique no bot√£o para testar</div>
        </div>

        <div class="test-section">
            <h2>üí≥ Teste de Payment Intent</h2>
            <button onclick="createTestPaymentIntent()">üí∞ Criar Payment Intent (R$ 39,97)</button>
            <div id="payment-intent-status" class="status info">Aguardando teste...</div>
        </div>

        <div class="test-section">
            <h2>üé® Teste de Stripe Elements</h2>
            <button onclick="initializeStripeElements()" id="init-elements-btn">üé® Inicializar Formul√°rio</button>
            <div id="stripe-elements-status" class="status info">Aguardando inicializa√ß√£o...</div>
            <div id="payment-element"></div>
            <button onclick="processTestPayment()" id="process-payment-btn" style="display: none;">üí∏ Processar
                Pagamento de Teste</button>
        </div>

        <div class="test-section">
            <h2>üìä Logs do Sistema</h2>
            <button onclick="clearLogs()">üóëÔ∏è Limpar Logs</button>
            <div id="system-logs" class="logs">Logs aparecer√£o aqui...</div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let stripe = null;
        let elements = null;
        let paymentElement = null;
        let currentClientSecret = null;

        // Sistema de logs
        function addLog(message, type = 'info') {
            const logs = document.getElementById('system-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logs.innerHTML += `[${timestamp}] ${logClass} ${message}\n`;
            logs.scrollTop = logs.scrollBottom;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('system-logs').innerHTML = 'Logs limpos...\n';
        }

        // Verificar conex√£o com backend
        async function checkBackendConnection() {
            try {
                addLog('Verificando conex√£o com backend...');
                const response = await fetch('http://localhost:3000/api/config/stripe-key');

                const statusDiv = document.getElementById('connection-status');
                if (response.ok) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Backend conectado e funcionando';
                    addLog('Backend conectado com sucesso', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                const statusDiv = document.getElementById('connection-status');
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Erro na conex√£o: ${error.message}`;
                addLog(`Erro na conex√£o com backend: ${error.message}`, 'error');
                return false;
            }
        }

        // Testar carregamento da chave Stripe
        async function testStripeKeyLoading() {
            try {
                addLog('Iniciando teste de carregamento da chave...');
                const statusDiv = document.getElementById('key-status');
                statusDiv.className = 'status info';
                statusDiv.textContent = 'üîÑ Carregando chave do backend...';

                const response = await fetch('http://localhost:3000/api/config/stripe-key');

                if (response.ok) {
                    const data = await response.json();
                    if (data.publishableKey && data.publishableKey.startsWith('pk_')) {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = `‚úÖ Chave carregada: ${data.publishableKey.substring(0, 20)}...`;
                        addLog(`Chave Stripe carregada com sucesso: ${data.publishableKey.substring(0, 20)}...`, 'success');

                        // Inicializar Stripe com a chave obtida
                        stripe = Stripe(data.publishableKey);
                        addLog('Stripe inicializado com chave din√¢mica', 'success');
                        return data.publishableKey;
                    } else {
                        throw new Error('Chave n√£o encontrada ou formato inv√°lido');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                const statusDiv = document.getElementById('key-status');
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Erro: ${error.message}`;
                addLog(`Erro ao carregar chave: ${error.message}`, 'error');
                return null;
            }
        }

        // Criar Payment Intent de teste
        async function createTestPaymentIntent() {
            try {
                const statusDiv = document.getElementById('payment-intent-status');
                statusDiv.className = 'status info';
                statusDiv.textContent = 'üîÑ Criando Payment Intent...';
                addLog('Criando Payment Intent de teste...');

                const response = await fetch('http://localhost:3000/create-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 3997, // R$ 39,97 em centavos
                        credits: 1,
                        plan: 'teste',
                        user_id: 'teste_usuario'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentClientSecret = data.client_secret;

                    statusDiv.className = 'status success';
                    statusDiv.textContent = `‚úÖ Payment Intent criado: ${data.payment_intent_id}`;
                    addLog(`Payment Intent criado com sucesso: ${data.payment_intent_id}`, 'success');
                    addLog(`Client Secret: ${currentClientSecret.substring(0, 20)}...`);

                    return data;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                const statusDiv = document.getElementById('payment-intent-status');
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Erro: ${error.message}`;
                addLog(`Erro ao criar Payment Intent: ${error.message}`, 'error');
                return null;
            }
        }

        // Inicializar Stripe Elements
        async function initializeStripeElements() {
            try {
                addLog('Inicializando Stripe Elements...');
                const statusDiv = document.getElementById('stripe-elements-status');
                statusDiv.className = 'status info';
                statusDiv.textContent = 'üîÑ Inicializando elementos...';

                // Garantir que temos Stripe inicializado
                if (!stripe) {
                    const key = await testStripeKeyLoading();
                    if (!key) {
                        throw new Error('N√£o foi poss√≠vel carregar a chave do Stripe');
                    }
                }

                // Garantir que temos client secret
                if (!currentClientSecret) {
                    addLog('Client Secret n√£o encontrado, criando Payment Intent...', 'warning');
                    const paymentData = await createTestPaymentIntent();
                    if (!paymentData) {
                        throw new Error('N√£o foi poss√≠vel criar Payment Intent');
                    }
                }

                // Configurar Elements
                const elementsOptions = {
                    clientSecret: currentClientSecret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#583819',
                            colorBackground: '#F3EADA',
                            colorText: '#443523',
                            fontFamily: 'Inter, sans-serif',
                            borderRadius: '6px',
                        }
                    },
                    locale: 'pt-BR'
                };

                elements = stripe.elements(elementsOptions);

                // Limpar container anterior
                const container = document.getElementById('payment-element');
                container.innerHTML = '';

                // Criar e montar Payment Element
                paymentElement = elements.create('payment', {
                    paymentMethodTypes: ['card'],
                    layout: { type: 'tabs', defaultCollapsed: false }
                });

                await paymentElement.mount('#payment-element');

                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Stripe Elements inicializado com sucesso!';
                addLog('Stripe Elements inicializado e montado', 'success');

                // Mostrar bot√£o de processar pagamento
                document.getElementById('process-payment-btn').style.display = 'inline-block';

            } catch (error) {
                const statusDiv = document.getElementById('stripe-elements-status');
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Erro: ${error.message}`;
                addLog(`Erro ao inicializar Stripe Elements: ${error.message}`, 'error');
            }
        }

        // Processar pagamento de teste (apenas confirma√ß√£o, n√£o cobran√ßa real)
        async function processTestPayment() {
            try {
                addLog('Processando pagamento de teste...');

                if (!stripe || !elements) {
                    throw new Error('Stripe n√£o foi inicializado corretamente');
                }

                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.href,
                    },
                    redirect: 'if_required'
                });

                if (error) {
                    addLog(`Erro no pagamento: ${error.message}`, 'error');
                } else {
                    addLog('Pagamento processado com sucesso!', 'success');
                }
            } catch (error) {
                addLog(`Erro ao processar pagamento: ${error.message}`, 'error');
            }
        }

        // Verificar conex√£o ao carregar a p√°gina
        window.addEventListener('load', () => {
            addLog('P√°gina carregada, iniciando verifica√ß√µes...');
            checkBackendConnection();
        });
    </script>
</body>

</html>

</html>