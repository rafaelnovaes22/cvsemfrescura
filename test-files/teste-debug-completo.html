<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Completo - Problema Real</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
        }

        .test-section h3 {
            color: #f39c12;
            margin-top: 0;
            font-size: 1.3rem;
        }

        .log-output {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
        }

        button {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        button.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        button.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        input {
            padding: 12px;
            margin: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .status.success {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid #27ae60;
        }

        .status.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }

        .status.warning {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid #f39c12;
        }

        .status.info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
        }

        .modal-simulation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Debug Completo - Problema dos C√≥digos de Presente</h1>

        <div class="test-section">
            <h3>üéØ Reproduzir Problema Exato do Usu√°rio</h3>
            <p><strong>Cen√°rio:</strong> Usu√°rio acessa analisar.html?giftCode=TESTE123 e login trava</p>

            <div>
                <input type="text" id="testCode" placeholder="C√≥digo" value="TESTE123">
                <input type="email" id="testEmail" placeholder="Email" value="teste@exemplo.com">
                <input type="password" id="testPassword" placeholder="Senha" value="123456">
            </div>

            <div style="margin: 15px 0;">
                <button onclick="simularAcessoComCodigo()" class="warning">üéÅ Simular Acesso com C√≥digo</button>
                <button onclick="simularLoginTravado()" class="error">üö® Simular Login Travado</button>
                <button onclick="testarCorre√ß√£o()" class="success">‚úÖ Testar Corre√ß√£o</button>
                <button onclick="limparTudo()" class="info">üßπ Limpar Tudo</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä Log de Execu√ß√£o</h3>
            <div id="debugLog" class="log-output">üîÑ Aguardando execu√ß√£o de testes...\n</div>
        </div>

        <div class="test-section">
            <h3>üåê Status do Backend</h3>
            <div id="backendStatus" class="status info">Verificando...</div>
            <button onclick="verificarBackend()" class="info">üîÑ Verificar Backend</button>
        </div>

        <div class="test-section">
            <h3>üîß Diagn√≥stico Detalhado</h3>
            <div id="diagnostico" class="log-output">Nenhum diagn√≥stico executado ainda.\n</div>
            <button onclick="executarDiagnosticoCompleto()" class="warning">üîç Diagn√≥stico Completo</button>
        </div>

        <!-- Modal simulado -->
        <div id="modalLogin" class="modal-simulation">
            <div class="modal-content">
                <h3>üîê Login em Progresso</h3>
                <p id="modalStatus">Processando login...</p>
                <div id="modalTimer" style="font-size: 24px; margin: 20px 0;">‚è∞ 0s</div>
                <button onclick="fecharModal()" style="background: #e74c3c;">‚ùå Fechar Modal (Simular Problema)</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.host.replace(':8080', ':3000');
        let modalTimer = 0;
        let modalInterval = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            const colors = {
                'info': '#3498db',
                'success': '#27ae60',
                'error': '#e74c3c',
                'warning': '#f39c12'
            };

            logDiv.innerHTML += `<span style="color: ${colors[type] || '#fff'}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function diag(message) {
            const timestamp = new Date().toLocaleTimeString();
            const diagDiv = document.getElementById('diagnostico');
            diagDiv.innerHTML += `<span style="color: #f39c12">[${timestamp}] ${message}</span>\n`;
            diagDiv.scrollTop = diagDiv.scrollHeight;
        }

        function limparTudo() {
            document.getElementById('debugLog').innerHTML = 'Log limpo.\n';
            document.getElementById('diagnostico').innerHTML = 'Diagn√≥stico limpo.\n';
            fecharModal();
            localStorage.clear();
            sessionStorage.clear();
            log('üßπ Tudo limpo', 'info');
        }

        function mostrarModal() {
            document.getElementById('modalLogin').style.display = 'flex';
            modalTimer = 0;
            modalInterval = setInterval(() => {
                modalTimer++;
                document.getElementById('modalTimer').textContent = `‚è∞ ${modalTimer}s`;

                // Simular que ap√≥s 10 segundos √© problema cr√≠tico
                if (modalTimer >= 10) {
                    document.getElementById('modalStatus').innerHTML =
                        `<span style="color: #e74c3c;">üö® PROBLEMA: Modal travado h√° ${modalTimer}s!</span>`;
                }
            }, 1000);
        }

        function fecharModal() {
            document.getElementById('modalLogin').style.display = 'none';
            if (modalInterval) {
                clearInterval(modalInterval);
                modalInterval = null;
            }
            modalTimer = 0;
        }

        async function verificarBackend() {
            const statusDiv = document.getElementById('backendStatus');
            statusDiv.textContent = 'Verificando...';
            statusDiv.className = 'status info';

            try {
                // Teste 1: Health check
                const health = await fetch(`${API_BASE}/api/health`);
                if (!health.ok) throw new Error('Health check falhou');

                // Teste 2: Valida√ß√£o de c√≥digo
                const validate = await fetch(`${API_BASE}/api/gift-code/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: 'TESTE123' })
                });
                const validateData = await validate.json();

                if (validateData.valid) {
                    statusDiv.innerHTML = `‚úÖ Backend OK - C√≥digo TESTE123 v√°lido (${validateData.credits} cr√©ditos, ${validateData.remainingUses} usos restantes)`;
                    statusDiv.className = 'status success';
                    log('‚úÖ Backend funcionando perfeitamente', 'success');
                } else {
                    statusDiv.innerHTML = `‚ö†Ô∏è Backend OK, mas c√≥digo inv√°lido: ${validateData.error}`;
                    statusDiv.className = 'status warning';
                    log('‚ö†Ô∏è Backend OK, c√≥digo inv√°lido', 'warning');
                }

            } catch (error) {
                statusDiv.innerHTML = `‚ùå Erro no backend: ${error.message}`;
                statusDiv.className = 'status error';
                log(`‚ùå Erro no backend: ${error.message}`, 'error');
            }
        }

        async function simularAcessoComCodigo() {
            log('üéÅ SIMULANDO: Usu√°rio acessa analisar.html?giftCode=TESTE123', 'warning');
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'warning');

            const code = document.getElementById('testCode').value;

            // Simular detec√ß√£o do c√≥digo na URL
            log(`1Ô∏è‚É£ C√≥digo detectado na URL: ${code}`, 'info');

            // Simular valida√ß√£o ANTES do login
            log('2Ô∏è‚É£ Validando c√≥digo ANTES do login...', 'info');

            try {
                const response = await fetch(`${API_BASE}/api/gift-code/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await response.json();

                if (data.valid) {
                    log(`‚úÖ C√≥digo v√°lido! ${data.credits} cr√©dito(s), ${data.remainingUses} usos restantes`, 'success');
                    log('3Ô∏è‚É£ Exibindo modal de boas-vindas...', 'info');
                    log('4Ô∏è‚É£ Usu√°rio clica em "J√° tenho conta" ou "Criar conta"', 'info');
                    log('5Ô∏è‚É£ Abrindo modal de login...', 'info');

                    // Simular que modal de login abre
                    mostrarModal();
                    document.getElementById('modalStatus').textContent = 'Aguardando login do usu√°rio...';

                    // Simular login ap√≥s 3 segundos
                    setTimeout(() => {
                        simularLoginComCodigo(code);
                    }, 3000);

                } else {
                    log(`‚ùå C√≥digo inv√°lido: ${data.error}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Erro na valida√ß√£o: ${error.message}`, 'error');
            }
        }

        async function simularLoginComCodigo(code) {
            log('6Ô∏è‚É£ Usu√°rio inseriu credenciais e clicou em "Entrar"', 'info');
            log('7Ô∏è‚É£ Simulando login bem-sucedido...', 'info');

            // Simular login bem-sucedido
            document.getElementById('modalStatus').textContent = 'Login bem-sucedido! Aplicando c√≥digo...';

            // Aqui √© onde pode dar problema - aplica√ß√£o do c√≥digo
            log('8Ô∏è‚É£ Tentando aplicar c√≥digo de presente...', 'warning');

            try {
                // Simular aplica√ß√£o do c√≥digo (vai falhar por n√£o ter token real)
                const response = await fetch(`${API_BASE}/api/gift-code/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer fake_token_for_simulation'
                    },
                    body: JSON.stringify({ code })
                });
                const data = await response.json();

                // Vai retornar erro de token inv√°lido
                if (data.error) {
                    log(`‚ö†Ô∏è Aplica√ß√£o falhou: ${data.error}`, 'warning');
                    log('üö® AQUI EST√Å O PROBLEMA: Se n√£o houvesse timeouts de seguran√ßa,', 'error');
                    log('   o modal ficaria aberto PARA SEMPRE!', 'error');

                    // Simular que sem as corre√ß√µes, ficaria travado
                    document.getElementById('modalStatus').innerHTML =
                        '<span style="color: #e74c3c;">üö® TRAVADO: authSuccess() nunca foi chamada!</span>';

                    // MAS com as corre√ß√µes, h√° timeouts de seguran√ßa
                    log('‚úÖ Por√©m, com as CORRE√á√ïES, h√° timeouts de seguran√ßa:', 'success');
                    log('   - Timeout de 2.5s vai for√ßar authSuccess()', 'success');
                    log('   - Backup de 5s como √∫ltimo recurso', 'success');

                    // Simular timeout de 2.5s
                    setTimeout(() => {
                        log('‚è∞ TIMEOUT 2.5s: For√ßando authSuccess() mesmo com erro!', 'success');
                        fecharModal();
                        log('‚úÖ Modal fechado com sucesso! Usu√°rio pode usar o site!', 'success');
                    }, 2500);
                }

            } catch (error) {
                log(`‚ùå Erro de rede: ${error.message}`, 'error');
                log('üö® Sem corre√ß√µes: Modal ficaria travado!', 'error');
                log('‚úÖ Com corre√ß√µes: Timeouts v√£o salvar!', 'success');
            }
        }

        async function simularLoginTravado() {
            log('üö® SIMULANDO: Login travado (comportamento ANTES das corre√ß√µes)', 'error');
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'error');

            mostrarModal();

            log('1Ô∏è‚É£ Login bem-sucedido', 'info');
            log('2Ô∏è‚É£ C√≥digo de presente detectado', 'info');
            log('3Ô∏è‚É£ Tentando aplicar c√≥digo...', 'warning');
            log('4Ô∏è‚É£ Aplica√ß√£o falha (erro de rede/servidor)', 'error');
            log('5Ô∏è‚É£ authSuccess() NUNCA √© chamada', 'error');
            log('6Ô∏è‚É£ Modal permanece aberto PARA SEMPRE!', 'error');

            document.getElementById('modalStatus').innerHTML =
                '<span style="color: #e74c3c;">üö® TRAVADO: authSuccess() nunca chamada!</span>';

            // N√£o fechar o modal - simular o travamento
            log('üíÄ Resultado: Usu√°rio n√£o consegue usar o site!', 'error');
            log('üí° Solu√ß√£o: Implementar timeouts de seguran√ßa', 'info');
        }

        async function testarCorre√ß√£o() {
            log('‚úÖ TESTANDO: Corre√ß√£o implementada (comportamento ATUAL)', 'success');
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');

            mostrarModal();

            log('1Ô∏è‚É£ Login bem-sucedido', 'info');
            log('2Ô∏è‚É£ C√≥digo de presente detectado: hasGiftCode = true', 'info');
            log('3Ô∏è‚É£ Configurando timeouts de seguran√ßa...', 'success');
            log('   ‚Ä¢ Timeout 2.5s: For√ßar authSuccess()', 'success');
            log('   ‚Ä¢ Backup 5s: √öltimo recurso', 'success');
            log('4Ô∏è‚É£ Tentando aplicar c√≥digo...', 'warning');

            // Simular timeout de 2.5s (mesmo se aplica√ß√£o falhar)
            setTimeout(() => {
                log('‚è∞ TIMEOUT 2.5s: Executando authSuccess() automaticamente!', 'success');
                fecharModal();
                log('‚úÖ SUCESSO: Modal fechado, usu√°rio pode usar o site!', 'success');
                log('üí° Resultado: C√≥digo pode ter falhado, mas usu√°rio n√£o fica travado!', 'success');
            }, 2500);

            // Simular backup de 5s
            setTimeout(() => {
                if (document.getElementById('modalLogin').style.display !== 'none') {
                    log('üîß BACKUP 5s: For√ßando fechamento como √∫ltimo recurso!', 'warning');
                    fecharModal();
                }
            }, 5000);
        }

        async function executarDiagnosticoCompleto() {
            diag('üîç INICIANDO DIAGN√ìSTICO COMPLETO');
            diag('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

            // Verificar backend
            diag('üì° Verificando conectividade do backend...');
            try {
                const health = await fetch(`${API_BASE}/api/health`);
                if (health.ok) {
                    diag('‚úÖ Backend est√° respondendo (200 OK)');
                } else {
                    diag(`‚ùå Backend retornou status: ${health.status}`);
                }
            } catch (error) {
                diag(`‚ùå Erro de conectividade: ${error.message}`);
            }

            // Verificar rota de valida√ß√£o
            diag('üéÅ Testando rota de valida√ß√£o de c√≥digos...');
            try {
                const validate = await fetch(`${API_BASE}/api/gift-code/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: 'TESTE123' })
                });
                const data = await validate.json();
                diag(`‚úÖ Valida√ß√£o OK: ${JSON.stringify(data)}`);
            } catch (error) {
                diag(`‚ùå Erro na valida√ß√£o: ${error.message}`);
            }

            // Verificar rota de aplica√ß√£o
            diag('üîß Testando rota de aplica√ß√£o de c√≥digos...');
            try {
                const apply = await fetch(`${API_BASE}/api/gift-code/apply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer fake_token'
                    },
                    body: JSON.stringify({ code: 'TESTE123' })
                });
                const data = await apply.json();
                diag(`‚ö†Ô∏è Aplica√ß√£o (token inv√°lido): ${JSON.stringify(data)}`);
            } catch (error) {
                diag(`‚ùå Erro na aplica√ß√£o: ${error.message}`);
            }

            // Verificar localStorage
            diag('üíæ Verificando localStorage...');
            const giftCode = localStorage.getItem('giftCode');
            const pendingCode = localStorage.getItem('pendingGiftCode');
            diag(`üéÅ giftCode: ${giftCode || 'null'}`);
            diag(`‚è≥ pendingGiftCode: ${pendingCode || 'null'}`);

            // Verificar URL atual
            diag('üåê Verificando URL atual...');
            const urlParams = new URLSearchParams(window.location.search);
            const urlCode = urlParams.get('giftCode');
            diag(`üîó C√≥digo na URL: ${urlCode || 'nenhum'}`);

            diag('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            diag('üéØ CONCLUS√ÉO DO DIAGN√ìSTICO:');

            if (giftCode || pendingCode || urlCode) {
                diag('üéÅ C√≥digo detectado - situa√ß√£o de gift code ativa');
                diag('üí° Se login travar, √© problema com timeouts de seguran√ßa');
            } else {
                diag('üö´ Nenhum c√≥digo detectado - comportamento normal esperado');
            }

            diag('‚úÖ Diagn√≥stico completo finalizado');
        }

        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            log('üîÑ Teste carregado e pronto para uso', 'info');
            log('üí° Use os bot√µes acima para reproduzir diferentes cen√°rios', 'info');
            verificarBackend();
        });
    </script>
</body>

</html>