<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Duplica√ß√£o de C√≥digo de Presente</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #583819;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e1e8ff;
            border-radius: 8px;
            background: #f8f9ff;
        }

        .test-title {
            font-weight: bold;
            color: #583819;
            margin-bottom: 10px;
        }

        .test-button {
            background: #583819;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }

        .test-button:hover {
            background: #6d4423;
        }

        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }

        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Teste - Duplica√ß√£o de C√≥digo de Presente</h1>

        <div class="test-section">
            <div class="test-title">üìã Status Atual</div>
            <div id="currentStatus" class="result info">Carregando...</div>
        </div>

        <div class="test-section">
            <div class="test-title">üîß Controles de Teste</div>
            <button class="test-button" onclick="clearAllData()">üóëÔ∏è Limpar Todos os Dados</button>
            <button class="test-button" onclick="simulateRegisterFlow()">üë§ Simular Cadastro + C√≥digo</button>
            <button class="test-button" onclick="simulateLoginFlow()">üîê Simular Login + C√≥digo</button>
            <button class="test-button" onclick="testDuplicateApplication()">‚ö†Ô∏è Testar Aplica√ß√£o Duplicada</button>
        </div>

        <div class="test-section">
            <div class="test-title">üìä Resultados dos Testes</div>
            <div id="testResults" class="result info">Nenhum teste executado ainda.</div>
        </div>

        <div class="test-section">
            <div class="test-title">üìù Logs de Debug</div>
            <button class="clear-btn" onclick="clearLogs()">Limpar Logs</button>
            <div id="debugLogs" class="logs"></div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const logs = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // Fun√ß√£o para limpar logs
        function clearLogs() {
            document.getElementById('debugLogs').innerHTML = '';
        }

        // Fun√ß√£o para atualizar status atual
        function updateCurrentStatus() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const giftCode = localStorage.getItem('giftCode');
            const pendingCode = localStorage.getItem('pendingGiftCode');
            const appliedCodes = JSON.parse(sessionStorage.getItem('appliedGiftCodes') || '[]');

            const status = `
                üîê Autenticado: ${token ? 'SIM' : 'N√ÉO'}
                üë§ Usu√°rio: ${user.name || 'N/A'}
                üí∞ Cr√©ditos: ${user.credits || 0}
                üéÅ C√≥digo na URL: ${new URLSearchParams(window.location.search).get('giftCode') || 'N/A'}
                üì¶ C√≥digo Local: ${giftCode || 'N/A'}
                ‚è≥ C√≥digo Pendente: ${pendingCode || 'N/A'}
                ‚úÖ C√≥digos Aplicados: ${appliedCodes.length > 0 ? appliedCodes.join(', ') : 'Nenhum'}
            `;

            document.getElementById('currentStatus').textContent = status;
            addLog(`Status atualizado - Cr√©ditos: ${user.credits || 0}, C√≥digos aplicados: ${appliedCodes.length}`);
        }

        // Fun√ß√£o para limpar todos os dados
        function clearAllData() {
            localStorage.clear();
            sessionStorage.clear();

            // Limpar par√¢metros da URL
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.delete('giftCode');
            window.history.replaceState({}, document.title, currentUrl.pathname);

            updateCurrentStatus();
            addLog('Todos os dados foram limpos', 'success');

            document.getElementById('testResults').textContent = 'Dados limpos. Pronto para novos testes.';
            document.getElementById('testResults').className = 'result success';
        }

        // Fun√ß√£o para simular fluxo de cadastro
        async function simulateRegisterFlow() {
            addLog('Iniciando simula√ß√£o de cadastro...', 'info');

            try {
                // Simular c√≥digo na URL
                const testCode = 'ADMIN123';
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('giftCode', testCode);
                window.history.replaceState({}, document.title, currentUrl.toString());

                // Simular dados de usu√°rio ap√≥s cadastro/login
                const mockUser = {
                    id: Math.floor(Math.random() * 1000),
                    name: 'Usu√°rio Teste',
                    email: 'teste@exemplo.com',
                    credits: 0
                };

                const mockToken = 'mock_token_' + Date.now();
                localStorage.setItem('token', mockToken);
                localStorage.setItem('user', JSON.stringify(mockUser));

                addLog('Usu√°rio simulado criado e logado', 'success');

                // Simular aplica√ß√£o do c√≥digo (primeira vez)
                await simulateGiftCodeApplication(testCode, 'Cadastro');

                updateCurrentStatus();

            } catch (error) {
                addLog(`Erro na simula√ß√£o de cadastro: ${error.message}`, 'error');
                document.getElementById('testResults').textContent = `Erro: ${error.message}`;
                document.getElementById('testResults').className = 'result error';
            }
        }

        // Fun√ß√£o para simular fluxo de login
        async function simulateLoginFlow() {
            addLog('Iniciando simula√ß√£o de login...', 'info');

            try {
                const testCode = 'ADMIN123';

                // Verificar se j√° h√° um usu√°rio
                const existingUser = JSON.parse(localStorage.getItem('user') || '{}');
                if (!existingUser.id) {
                    addLog('Nenhum usu√°rio encontrado. Execute primeiro o teste de cadastro.', 'warning');
                    document.getElementById('testResults').textContent = 'Execute primeiro o teste de cadastro.';
                    document.getElementById('testResults').className = 'result warning';
                    return;
                }

                // Simular aplica√ß√£o do c√≥digo (segunda vez - deve ser bloqueada)
                await simulateGiftCodeApplication(testCode, 'Login');

                updateCurrentStatus();

            } catch (error) {
                addLog(`Erro na simula√ß√£o de login: ${error.message}`, 'error');
                document.getElementById('testResults').textContent = `Erro: ${error.message}`;
                document.getElementById('testResults').className = 'result error';
            }
        }

        // Fun√ß√£o para testar aplica√ß√£o duplicada diretamente
        async function testDuplicateApplication() {
            addLog('Testando aplica√ß√£o duplicada direta...', 'info');

            const testCode = 'ADMIN123';

            // Primeira aplica√ß√£o
            await simulateGiftCodeApplication(testCode, 'Primeira tentativa');

            // Segunda aplica√ß√£o (deve ser bloqueada)
            setTimeout(async () => {
                await simulateGiftCodeApplication(testCode, 'Segunda tentativa (deve ser bloqueada)');
                updateCurrentStatus();
            }, 1000);
        }

        // Fun√ß√£o para simular aplica√ß√£o de c√≥digo de presente
        async function simulateGiftCodeApplication(code, context) {
            addLog(`Aplicando c√≥digo ${code} - Contexto: ${context}`, 'info');

            // Verificar se este c√≥digo j√° foi aplicado nesta sess√£o
            const appliedCodes = JSON.parse(sessionStorage.getItem('appliedGiftCodes') || '[]');
            if (appliedCodes.includes(code)) {
                addLog(`üîÑ C√≥digo ${code} j√° aplicado nesta sess√£o - BLOQUEADO`, 'warning');
                document.getElementById('testResults').textContent = `‚úÖ SUCESSO: Duplica√ß√£o bloqueada para ${code} no contexto "${context}"`;
                document.getElementById('testResults').className = 'result success';
                return;
            }

            try {
                // Simular chamada para API (sem fazer requisi√ß√£o real)
                addLog(`Simulando requisi√ß√£o para /api/gift-code/apply com c√≥digo ${code}`, 'info');

                // Simular resposta de sucesso
                const mockResponse = {
                    success: true,
                    message: 'C√≥digo aplicado com sucesso!',
                    credits: 1
                };

                // Marcar c√≥digo como aplicado
                appliedCodes.push(code);
                sessionStorage.setItem('appliedGiftCodes', JSON.stringify(appliedCodes));

                // Atualizar cr√©ditos do usu√°rio
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                user.credits = (user.credits || 0) + 1;
                localStorage.setItem('user', JSON.stringify(user));

                addLog(`‚úÖ C√≥digo ${code} aplicado com sucesso - Cr√©ditos: ${user.credits}`, 'success');

                document.getElementById('testResults').textContent = `C√≥digo ${code} aplicado no contexto "${context}" - Cr√©ditos: ${user.credits}`;
                document.getElementById('testResults').className = 'result success';

            } catch (error) {
                addLog(`‚ùå Erro ao aplicar c√≥digo ${code}: ${error.message}`, 'error');
                document.getElementById('testResults').textContent = `Erro: ${error.message}`;
                document.getElementById('testResults').className = 'result error';
            }
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function () {
            addLog('P√°gina de teste carregada', 'info');
            updateCurrentStatus();
        });
    </script>
</body>

</html>