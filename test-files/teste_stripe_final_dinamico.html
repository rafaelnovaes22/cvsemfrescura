<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Teste Final - Sistema Stripe 100% Din√¢mico</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="assets/js/config.js"></script>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #583819 0%, #8B4513 100%);
            color: white;
            border-radius: 10px;
        }

        .status-card {
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }

        .test-section {
            margin: 25px 0;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: #f8f9fa;
        }

        .test-section h3 {
            margin-top: 0;
            color: #583819;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button {
            background: linear-gradient(135deg, #583819 0%, #8B4513 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(88, 56, 25, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(88, 56, 25, 0.4);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .logs {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #4a5568;
        }

        .config-display {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 13px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge.success {
            background: #28a745;
            color: white;
        }

        .badge.error {
            background: #dc3545;
            color: white;
        }

        .badge.warning {
            background: #ffc107;
            color: #212529;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ Sistema Stripe 100% Din√¢mico</h1>
            <p>Teste completo sem chaves hardcoded - Tudo via API</p>
        </div>

        <div class="test-section">
            <h3>üîß Configura√ß√£o do Sistema</h3>
            <div id="config-status" class="status-card info">üîÑ Carregando configura√ß√µes...</div>
            <div class="config-display" id="config-display">
                <strong>Configura√ß√µes carregadas:</strong><br>
                <span id="config-details">Aguardando...</span>
            </div>
        </div>

        <div class="test-section">
            <h3>üîë Teste de Chaves Din√¢micas</h3>
            <button onclick="testDynamicKeys()">üîÑ Testar Carregamento de Chaves</button>
            <div id="keys-status" class="status-card info">Clique para testar</div>
        </div>

        <div class="test-section">
            <h3>üåê Conectividade Backend</h3>
            <button onclick="testBackendConnection()">üì° Testar Conex√£o</button>
            <div id="backend-status" class="status-card info">Clique para testar</div>
        </div>

        <div class="test-section">
            <h3>üí≥ Payment Intent Din√¢mico</h3>
            <button onclick="testPaymentIntent()">üí∞ Criar Payment Intent</button>
            <div id="payment-status" class="status-card info">Aguardando teste</div>
        </div>

        <div class="test-section">
            <h3>üé® Stripe Elements Din√¢mico</h3>
            <button onclick="testStripeElements()" id="elements-btn">üé® Inicializar Elements</button>
            <div id="elements-status" class="status-card info">Aguardando inicializa√ß√£o</div>
            <div id="payment-element"
                style="margin: 20px 0; padding: 20px; border: 2px dashed #dee2e6; border-radius: 8px; min-height: 200px; display: none;">
            </div>
        </div>

        <div class="test-section">
            <h3>üìä Logs do Sistema</h3>
            <button onclick="clearLogs()">üóëÔ∏è Limpar Logs</button>
            <button onclick="runFullTest()">üöÄ Executar Teste Completo</button>
            <div id="system-logs" class="logs">Sistema iniciado...\n</div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let stripe = null;
        let elements = null;
        let paymentElement = null;
        let currentClientSecret = null;
        let systemConfig = null;

        // Sistema de logs melhorado
        function addLog(message, type = 'info') {
            const logs = document.getElementById('system-logs');
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'debug': 'üîç'
            };

            const icon = icons[type] || '‚ÑπÔ∏è';
            logs.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('system-logs').innerHTML = 'Logs limpos...\n';
            addLog('Sistema reiniciado', 'info');
        }

        // Carregar configura√ß√µes do sistema
        async function loadSystemConfig() {
            try {
                addLog('Carregando configura√ß√µes do sistema...', 'debug');

                // Verificar se CONFIG est√° dispon√≠vel
                if (typeof CONFIG === 'undefined') {
                    throw new Error('Arquivo config.js n√£o foi carregado');
                }

                systemConfig = CONFIG;

                const configDiv = document.getElementById('config-display');
                const statusDiv = document.getElementById('config-status');

                configDiv.innerHTML = `
                    <strong>‚úÖ Configura√ß√µes Carregadas:</strong><br>
                    ‚Ä¢ API Base URL: ${CONFIG.api.baseUrl}<br>
                    ‚Ä¢ Ambiente: ${CONFIG.environment}<br>
                    ‚Ä¢ Endpoints: ${Object.keys(CONFIG.api.endpoints).length} configurados<br>
                    ‚Ä¢ Modo: 100% Din√¢mico (sem chaves hardcoded)
                `;

                statusDiv.className = 'status-card success';
                statusDiv.innerHTML = '‚úÖ Configura√ß√µes carregadas com sucesso <span class="badge success">DIN√ÇMICO</span>';

                addLog('Configura√ß√µes do sistema carregadas com sucesso', 'success');
                return true;
            } catch (error) {
                const statusDiv = document.getElementById('config-status');
                statusDiv.className = 'status-card error';
                statusDiv.innerHTML = `‚ùå Erro ao carregar configura√ß√µes: ${error.message}`;
                addLog(`Erro nas configura√ß√µes: ${error.message}`, 'error');
                return false;
            }
        }

        // Testar carregamento din√¢mico de chaves
        async function testDynamicKeys() {
            try {
                addLog('Iniciando teste de chaves din√¢micas...', 'debug');
                const statusDiv = document.getElementById('keys-status');
                statusDiv.className = 'status-card info';
                statusDiv.innerHTML = 'üîÑ Carregando chave do backend...';

                // Usar fun√ß√£o do config.js
                const stripeKey = await getStripeKey();

                if (stripeKey) {
                    statusDiv.className = 'status-card success';
                    statusDiv.innerHTML = `‚úÖ Chave carregada dinamicamente: ${stripeKey.substring(0, 20)}... <span class="badge success">DIN√ÇMICO</span>`;
                    addLog(`Chave Stripe obtida via API: ${stripeKey.substring(0, 20)}...`, 'success');

                    // Inicializar Stripe
                    stripe = Stripe(stripeKey);
                    addLog('Stripe inicializado com chave din√¢mica', 'success');
                    return true;
                } else {
                    throw new Error('N√£o foi poss√≠vel obter chave do backend');
                }
            } catch (error) {
                const statusDiv = document.getElementById('keys-status');
                statusDiv.className = 'status-card error';
                statusDiv.innerHTML = `‚ùå Erro: ${error.message} <span class="badge error">FALHOU</span>`;
                addLog(`Erro ao carregar chaves: ${error.message}`, 'error');
                return false;
            }
        }

        // Testar conex√£o com backend
        async function testBackendConnection() {
            try {
                addLog('Testando conectividade com backend...', 'debug');
                const statusDiv = document.getElementById('backend-status');
                statusDiv.className = 'status-card info';
                statusDiv.innerHTML = 'üîÑ Verificando conex√£o...';

                const isConnected = await checkBackendConnection();

                if (isConnected) {
                    statusDiv.className = 'status-card success';
                    statusDiv.innerHTML = '‚úÖ Backend conectado e respondendo <span class="badge success">ONLINE</span>';
                    addLog('Conex√£o com backend estabelecida', 'success');
                    return true;
                } else {
                    throw new Error('Backend n√£o est√° respondendo');
                }
            } catch (error) {
                const statusDiv = document.getElementById('backend-status');
                statusDiv.className = 'status-card error';
                statusDiv.innerHTML = `‚ùå Erro de conex√£o: ${error.message} <span class="badge error">OFFLINE</span>`;
                addLog(`Erro de conex√£o: ${error.message}`, 'error');
                return false;
            }
        }

        // Testar cria√ß√£o de Payment Intent
        async function testPaymentIntent() {
            try {
                addLog('Criando Payment Intent via API...', 'debug');
                const statusDiv = document.getElementById('payment-status');
                statusDiv.className = 'status-card info';
                statusDiv.innerHTML = 'üîÑ Criando Payment Intent...';

                const response = await fetch(`${CONFIG.api.baseUrl}/create-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 3997, // R$ 39,97
                        credits: 1,
                        plan: 'teste-dinamico',
                        user_id: 'teste_usuario_dinamico'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentClientSecret = data.client_secret;

                    statusDiv.className = 'status-card success';
                    statusDiv.innerHTML = `‚úÖ Payment Intent criado: ${data.payment_intent_id} <span class="badge success">DIN√ÇMICO</span>`;
                    addLog(`Payment Intent criado com sucesso: ${data.payment_intent_id}`, 'success');
                    addLog(`Client Secret obtido: ${currentClientSecret.substring(0, 20)}...`, 'debug');
                    return true;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                const statusDiv = document.getElementById('payment-status');
                statusDiv.className = 'status-card error';
                statusDiv.innerHTML = `‚ùå Erro: ${error.message} <span class="badge error">FALHOU</span>`;
                addLog(`Erro ao criar Payment Intent: ${error.message}`, 'error');
                return false;
            }
        }

        // Testar Stripe Elements
        async function testStripeElements() {
            try {
                addLog('Inicializando Stripe Elements dinamicamente...', 'debug');
                const statusDiv = document.getElementById('elements-status');
                statusDiv.className = 'status-card info';
                statusDiv.innerHTML = 'üîÑ Inicializando Elements...';

                // Garantir que temos Stripe inicializado
                if (!stripe) {
                    addLog('Stripe n√£o inicializado, carregando chaves...', 'warning');
                    const success = await testDynamicKeys();
                    if (!success) {
                        throw new Error('N√£o foi poss√≠vel inicializar Stripe');
                    }
                }

                // Garantir que temos client secret
                if (!currentClientSecret) {
                    addLog('Client Secret n√£o encontrado, criando Payment Intent...', 'warning');
                    const success = await testPaymentIntent();
                    if (!success) {
                        throw new Error('N√£o foi poss√≠vel criar Payment Intent');
                    }
                }

                // Configurar Elements
                const elementsOptions = {
                    clientSecret: currentClientSecret,
                    appearance: {
                        theme: 'stripe',
                        variables: {
                            colorPrimary: '#583819',
                            colorBackground: '#F3EADA',
                            colorText: '#443523',
                            fontFamily: 'Inter, sans-serif',
                            borderRadius: '8px',
                        }
                    },
                    locale: 'pt-BR'
                };

                elements = stripe.elements(elementsOptions);

                // Mostrar container
                const container = document.getElementById('payment-element');
                container.style.display = 'block';
                container.innerHTML = '';

                // Criar e montar Payment Element
                paymentElement = elements.create('payment', {
                    paymentMethodTypes: ['card'],
                    layout: { type: 'tabs', defaultCollapsed: false }
                });

                await paymentElement.mount('#payment-element');

                statusDiv.className = 'status-card success';
                statusDiv.innerHTML = '‚úÖ Stripe Elements carregado dinamicamente <span class="badge success">FUNCIONANDO</span>';
                addLog('Stripe Elements inicializado com sucesso via API', 'success');

                return true;

            } catch (error) {
                const statusDiv = document.getElementById('elements-status');
                statusDiv.className = 'status-card error';
                statusDiv.innerHTML = `‚ùå Erro: ${error.message} <span class="badge error">FALHOU</span>`;
                addLog(`Erro ao inicializar Elements: ${error.message}`, 'error');
                return false;
            }
        }

        // Executar teste completo
        async function runFullTest() {
            addLog('üöÄ Iniciando teste completo do sistema...', 'info');

            const tests = [
                { name: 'Configura√ß√µes', func: loadSystemConfig },
                { name: 'Conex√£o Backend', func: testBackendConnection },
                { name: 'Chaves Din√¢micas', func: testDynamicKeys },
                { name: 'Payment Intent', func: testPaymentIntent },
                { name: 'Stripe Elements', func: testStripeElements }
            ];

            let passed = 0;
            let failed = 0;

            for (const test of tests) {
                addLog(`Executando teste: ${test.name}...`, 'debug');
                try {
                    const result = await test.func();
                    if (result) {
                        passed++;
                        addLog(`‚úÖ ${test.name}: PASSOU`, 'success');
                    } else {
                        failed++;
                        addLog(`‚ùå ${test.name}: FALHOU`, 'error');
                    }
                } catch (error) {
                    failed++;
                    addLog(`‚ùå ${test.name}: ERRO - ${error.message}`, 'error');
                }

                // Pequena pausa entre testes
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            addLog(`üèÅ Teste completo finalizado: ${passed} passou(m), ${failed} falhou(ram)`,
                failed === 0 ? 'success' : 'warning');

            if (failed === 0) {
                addLog('üéâ SISTEMA 100% FUNCIONAL VIA API!', 'success');
            }
        }

        // Inicializar sistema ao carregar
        window.addEventListener('load', async () => {
            addLog('P√°gina carregada, inicializando sistema...', 'info');
            await loadSystemConfig();
            addLog('Sistema pronto para testes', 'success');
        });
    </script>
</body>

</html>